---
title: "EOL Report"
author: "[The Strategy Unit][su_web]"
output:
  StrategyUnitTheme::su_document: default
params:
  stp: "E54000016"
  region_report: true
---

```{r setup, include=FALSE}
library(knitr)
# knitr options ----
opts_chunk$set(echo = FALSE, eval.after = "fig.cap")

if (!knitr::is_latex_output()) {
  opts_chunk$set(dpi = 300,
                 dev.args = list(type = "cairo"))
}

# all setup should happen in setup.R that could be shared logic between files
invisible(local({
  source("setup.R")
  load_data(params$stp, params$region_report)
}))

activity_costs <- file.path("data", "sensitive", "activity_costs.fst") %>%
  read_fst() %>%
  as_tibble() %>%
  semi_join(mpi, by = "su_pat_id") %>%
  mutate_at("ss_flag", fct_recode, "Spec. Services" = "SS") %>%
  mutate_at("pod_type",
            fct_recode,
            "Critical Care" = "CriticalCare",
            "Bed" = "BED",
            "Planned Contact" = "PlannedContact",
            #"Planned Event" = "PlannedEvent"
            "Planned Admission" = "PlannedEvent",
            "Urgent Service Event" = "Unplanned") %>%
  mutate_at("pod_type",
            fct_relevel,
            #"Unplanned",
            "Urgent Service Event",
            "Planned Contact",
            #"Planned Event",
            "Planned Admission",
            "Bed",
            "Critical Care Bed Day") %>%
  
  mutate(cc_pod_summary_group = ifelse(pod_type == "Critical Care Bed Day",
                                       as.character(pod_summary_group),
                                       NA)) %>%
  mutate_at("cc_pod_summary_group",
            fct_recode,
            "Elective Admission" = "EL",
            "Elective Admission" = "DC",
            "Emergency Admission" = "EM") %>%
  mutate_at("pod_summary_group",
            ~case_when(pod_type == "Critical Care Bed Day" ~ "CCBD",
                       pod_type == "Bed" ~ paste0(as.character(.x), "BD"),
                       TRUE ~ as.character(.x))) %>%
  mutate_at("pod_summary_group",
            fct_relevel,
            "EM", "AE", "111",
            "OP", "MH", "IAPT",
            "DC", "RA", "EL",
            "EMBD", "ELBD", "CCBD") %>%
  mutate_at("pod_summary_group",
            fct_recode,
            "Emergency Admission" = "EM",
            "A&E Attendance" = "AE",
            "111 Call" = "111",
            "Outpatient Attendance" = "OP",
            "Mental Health Contact" = "MH",
            "IAPT Contact" = "IAPT",
            "Day Case Admission" = "DC",
            "Regular Attendance Admission" = "RA",
            "Elective Admission" = "EL",
            "Emergency Admission Bed Day" = "EMBD",
            "Elective Admission Bed Day" = "ELBD",
            "Critical Care Bed Day" = "CCBD") %>%
  mutate_at("pod_type", fct_recode, "Bed" = "Critical Care Bed Day") %>%
  mutate_at("pod_summary_group",
            ~ifelse(pod_type == "Critical Care" & .x == "Day Case Admission",
                    "Elective Admission",
                    as.character(.x)) %>%
              fct_relevel(levels(.x))) %>%
  mutate_at("pod_type", fct_explicit_na) %>%
  rename(cost = final_cost) %>%
  modify_at("cost", replace_na, 0)

library(magrittr)
# update levels of ss_flag
activity_costs %<>%
  mutate("simple_ss_flag" = fct_collapse(ss_flag, "Other" = activity_costs %>%
           group_by(ss_flag) %>% 
           summarise_at("cost", sum) %>% 
           filter((cost / sum(cost)) <= 0.01) %>% 
           pull(ss_flag) %>% 
           as.character())) %>%
   mutate_at("pod_type",
            fct_recode,
            "Critical Care" = "CC",
            "Other" = "Unknown",
            "Other" = "(Missing)")
```

# Costing

#### Average spend per person

```{r avg cost split by payer, fig.height = 1}
activity_costs %>%
  group_by(simple_ss_flag) %>%
  summarise_at("cost", sum) %>%
  mutate(avg_cost = cost / nrow(mpi)) %>%
  mutate_at("simple_ss_flag", fct_reorder, quo(avg_cost)) %>%
  ggplot(aes(avg_cost, "", colour = simple_ss_flag)) +
  geom_col(aes(fill = after_scale(alpha(colour, 0.4)))) +
  scale_colour_manual(values = c(
    "CCG" = su_theme_cols("red")[[1]],
    "Spec. Services" = su_theme_cols("orange")[[1]],
    "Other" = su_theme_cols("charcoal")[[1]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(labels = comma_format(prefix = "£")) +
  scale_y_discrete(expand = expansion()) +
  labs(x = "", y = "", colour = "") +
  theme(legend.position = "bottom",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.title = element_blank())
```

```{r avg cost split by payer and cod, fig.height = 2}
activity_costs %>%
  inner_join(mpi, by = "su_pat_id") %>%
  filter(group != "(Missing)") %>%
  group_by(group, simple_ss_flag) %>%
  summarise_at("cost", sum) %>%
  inner_join(count(mpi, group, name = "nd"), by = "group") %>%
  mutate(avg_cost = cost / nd) %>%
  mutate_at("simple_ss_flag", fct_reorder, quo(avg_cost)) %>%
  ggplot(aes(avg_cost, fct_rev(group), colour = simple_ss_flag)) +
  geom_col(aes(fill = after_scale(alpha(colour, 0.4)))) +
  scale_colour_manual(values = c(
    "CCG" = su_theme_cols("red")[[1]],
    "Spec. Services" = su_theme_cols("orange")[[1]],
    "Other" = su_theme_cols("charcoal")[[1]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(labels = comma_format(prefix = "£")) +
  scale_y_discrete(expand = expansion()) +
  labs(x = "", y = "", colour = "") +
  theme(legend.position = "bottom",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title.y = element_blank())
```

#### Average spend per pod type for all decedents

```{r}
activity_costs %>%
  group_by(pod_type, simple_ss_flag) %>%
  summarise_at("cost", sum) %>%
  mutate(avg_cost = cost / nrow(mpi)) %>%
  mutate_at("simple_ss_flag", fct_relevel, "CCG", "Spec. Services", "Other") %>%
  ggplot(aes(avg_cost, pod_type, colour = fct_rev(simple_ss_flag))) +
  geom_col(aes(fill = after_scale(alpha(colour, 0.4)))) +
  scale_colour_manual(values = c(
    "CCG" = su_theme_cols("red")[[1]],
    "Spec. Services" = su_theme_cols("orange")[[1]],
    "Other" = su_theme_cols("charcoal")[[1]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(labels = comma_format(prefix = "£")) +
  scale_y_discrete(expand = expansion()) +
  labs(x = "", y = "", colour = "") +
  theme(legend.position = "bottom",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

#### Average spend per pod type for decedents who had that type of activity

```{r}
activity_costs %>%
  group_by(simple_ss_flag, pod_type, su_pat_id) %>%
  filter(cost > 0) %>%
  summarise_at("cost", sum) %>%
  summarise_at("cost", mean) %>%
  ungroup() %>%
  mutate_at("simple_ss_flag", fct_relevel, "CCG", "Spec. Services", "Other") %>%
  complete(pod_type, simple_ss_flag) %>%
  filter(pod_type != "Bed", simple_ss_flag != "Other") %>%
  ggplot(aes(cost, fct_rev(pod_type), colour = fct_rev(simple_ss_flag))) +
  geom_col(aes(fill = after_scale(alpha(colour, 0.4))),
           position = "dodge") +
  scale_colour_manual(values = c(
    "CCG" = su_theme_cols("red")[[1]],
    "Spec. Services" = su_theme_cols("orange")[[1]],
    "Other" = su_theme_cols("charcoal")[[1]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(labels = comma_format(prefix = "£")) +
  scale_y_discrete(expand = expansion()) +
  labs(x = "", y = "", colour = "") +
  theme(legend.position = "bottom",
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
```

note: it's not valid to add these bars up, as each bar is the average for that
`pod_type` for patients who had that type of activity

#### Average spend per pod type per activity

```{r, fig.height = 9}
activity_costs %>%
  filter(cost > 0) %>%
  mutate_at("pod_summary_group", paste0, "\n", quo(simple_ss_flag)) %>%
  group_by(pod_type) %>%
  mutate(n_pt = n()) %>%
  group_by(pod_summary_group, add = TRUE) %>%
  mutate(n_psg = n()) %>%
  filter(n_psg > 1000 | (n_psg/n_pt) > 0.01) %>%
  ggplot(aes(cost, pod_summary_group, colour = simple_ss_flag)) +
  geom_boxplot(width = 0.5, coef = Inf) +
  scale_x_continuous(labels = comma_format(prefix = "£"),
                     trans = "log10",
                     expand = expansion(c(0.1, 0.05))) +
  scale_y_discrete(labels = partial(str_wrap, width = 15)) +
  theme(legend.position = "none") +
  labs(x = "", y = "") +
  facet_wrap(vars(pod_type), scales = "free", ncol = 2)
```


```{r, fig.height = 9}
p <- activity_costs %>%
  filter(cost > 0) %>%
  ggplot(aes(cost, pod_summary_group, colour = simple_ss_flag)) +
  geom_density_ridges(aes(fill = after_scale(alpha(colour, 0.4)))) +
  facet_wrap(vars(pod_type), scales = "free") +
  scale_x_continuous(labels = comma_format(prefix = "£"),
                     trans = "log10",
                     expand = expansion(c(0.1, 0.05))) +
  scale_y_discrete(labels = partial(str_wrap, width = 15)) +
  theme(legend.position = "bottom") +
  labs(x = "", y = "", colour = "") +
  facet_wrap(vars(pod_type), scales = "free", ncol = 2)

suppressMessages(print(p))
```

```{r}
local({
  df <- activity_costs %>%
    group_by(pod_type) %>%
    filter(cost > 0,
           !all(simple_ss_flag == "Spec. Services")) %>%
    ungroup() %>%
    mutate_at("pod_summary_group", ~case_when(
      pod_type == "Urgent Service Event" & ss_flag == "Spec. Services" ~
        "Emergency Admission",
      pod_type == "Planned Contact" & ss_flag == "Spec. Services" ~
        "Outpatient Attendance",
      pod_type == "Planned Admission" & ss_flag == "Spec. Services" ~
        "Elective Admission",
      pod_type == "Critical Care" & ss_flag == "Spec. Services" ~
        "Emergency Admission",
      TRUE ~ as.character(.x))) %>%
    #filter(simple_ss_flag != "Other") %>%
    group_nest(pod_type, pod_summary_group) %>%
    mutate_at("pod_type", as.character)
  
  df <- bind_rows(
    df,
    activity_costs %>%
      group_by(pod_type) %>%
      filter(cost > 0,
             all(simple_ss_flag == "Spec. Services")) %>%
      ungroup() %>%
      mutate(simple_ss_flag = pod_type,
             pod_type = "Other",
             pod_summary_group = "Spec. Services") %>%
      group_nest(pod_type, pod_summary_group)
  )
    
  df %>%
    pmap(function(pod_type, pod_summary_group, data) {
      ggplot(data, aes(cost, simple_ss_flag, colour = simple_ss_flag)) +
        geom_density_ridges(aes(fill = after_scale(alpha(colour, 0.4)))) +
        scale_x_continuous(labels = comma_format(prefix = "£"),
                     trans = "log10",
                     expand = expansion(c(0.1, 0.05))) +
        scale_y_discrete(labels = partial(str_wrap, width = 15)) +
        theme(legend.position = "none") +
        labs(x = "", y = "", colour = "", title = pod_type,
             subtitle = pod_summary_group)
    })
}) %>%
  walk(quietly(print))
```

# Specialised Services spend per person

$$
\frac{\Sigma(\textrm{cost of spec. services by pod_type/day})}
{\textrm{number of decedents in stp}}
$$

includes all decedents, whether they had Spec. Services or not.

```{r}

activity_costs %>%
  filter(ss_flag == "Spec. Services",
         !pod_type %in% c("CC", "Bed")) %>%
  mutate_at("pod_type",
            fct_recode,
            "Device + Drug" = "Device",
            "Device + Drug" = "Drug") %>%
  group_by(pod_type, proximity_to_death_days) %>%
  summarise_at("cost", sum) %>% {
    .x <- .
    list(pod_type = unique(.x$pod_type),
         proximity_to_death_days = range(.x$proximity_to_death_days) %>%
           (lift_dv(seq))) %>%
      cross_df() %>%
      left_join(.x, by = c("pod_type", "proximity_to_death_days"))
  } %>%
  modify_at("cost", replace_na, 0) %>%
  mutate_at("cost", `/`, nrow(mpi)) %>%
  group_nest(pod_type) %>%
  pmap(function(pod_type, data) {
    data %>%
      ggplot(aes(proximity_to_death_days, cost)) +
      geom_smooth(span = 0.15,
                  formula = y ~ x,
                  method = "loess",
                  fill = NA,
                  colour = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
      geom_point(size = 0.2,
                 shape = "circle filled",
                 colour = su_theme_cols()[["orange"]],
                 fill = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
      scale_x_proximity_to_death_days() +
      scale_y_continuous(labels = comma_format(prefix = "£")) +
      labs(x = "", y = "", title = pod_type)
  })
```

# Specialised Services access

```{r}
activity_costs %>%
  filter(!pod_type %in% c("Bed")) %>%
  group_by(pod_type) %>%
  summarise(n  = n_distinct(su_pat_id),
            ss = n_distinct(ifelse(ss_flag == "Spec. Services",
                                   su_pat_id,
                                   NA),
                            na.rm = TRUE),
            .groups = "drop_last") %>%
  mutate_at(vars(-pod_type), `/`, nrow(mpi)) %>%
  mutate(n = n - ss) %>%
  pivot_longer(-pod_type) %>%
  filter(value > 0) %>%
  mutate(label = ifelse(name == "ss", percent(value, accuracy = 1), NA)) %>%
  ggplot(aes(pod_type, value)) +
  geom_col(aes(colour = name, fill = after_scale(alpha(colour, 0.4))),
           position = "stack") +
  scale_x_discrete(labels = partial(str_wrap, width = 10)) +
  scale_y_continuous(labels = percent,
                     expand = expansion(c(0, 0.05))) +
  coord_cartesian(ylim = c(0, 1)) +
  geom_text(aes(label = label, group = name),
            position = "stack",
            na.rm = TRUE,
            vjust = -0.5,
            size = 3) +
  labs(x = "", y = "") +
  theme(axis.title = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none")
```

# All spend

```{r}
spend_plot <- function(pod_type, data) {
  data %>%
    group_by(proximity_to_death_days) %>%
    summarise_at("cost", sum) %>%
    ggplot(aes(proximity_to_death_days, cost)) +
    geom_point(colour = su_theme_cols("orange"),
               fill = alpha(su_theme_cols("orange"), 0.4),
               shape = "circle filled") +
    geom_smooth(method = "loess",
                formula = y ~ x,
                span = 0.2,
                colour = su_theme_cols("orange"),
                fill = NA) +
    scale_x_proximity_to_death_days() +
    scale_y_continuous(labels = number_format(prefix = "£",
                                              suffix = "m",
                                              scale = 1e-6),
                       position = "right") +
    theme(axis.title.y.right = element_text(margin = margin(l = 10))) +
    labs(x = "Proximity to Death (Months)",
         y = "Spend",
         title = pod_type)
}

activity_costs_ex_bed <- activity_costs %>%
  filter(pod_type != "Bed")

spend_plot("All Activity", activity_costs_ex_bed)

activity_costs_ex_bed %>%
  group_nest(pod_type) %>%
  pmap(spend_plot) %>%
  walk(plot)
```
# Specialised services spend

```{r}

activity_costs_ex_bed <- filter(activity_costs, pod_type != "Bed")

spend_plot("All Activity", activity_costs_ex_bed %>%
             filter(ss_flag == "Spec. Services", pod_type != "Bed"))

activity_costs_ex_bed %>%
  filter(ss_flag == "Spec. Services", pod_type != "Bed") %>%
  group_nest(pod_type) %>%
  pmap(spend_plot) %>%
  walk(plot)
```
# Daily % split of Specialised Services to All Spend

```{r}

ccg_pod_types <- activity_costs %>%
  filter(ss_flag == "CCG") %>%
  distinct(pod_type)

activity_costs %>%
  group_by(proximity_to_death_days, ss_flag) %>%
  # exclude extreme points
  filter(cost < 600000) %>%
  semi_join(ccg_pod_types, by = "pod_type") %>%
  summarise_at("cost", sum) %>%
  summarise(all = sum(cost),
            spec_services = ifelse(ss_flag == "Spec. Services",
                                   cost,
                                   0) %>% sum(),
            percent = spec_services/all,
            .groups = "drop_last") %>%
  ggplot(aes(proximity_to_death_days, percent)) +
  geom_point(colour = su_theme_cols("orange"),
             fill = after_scale(alpha(su_theme_cols("orange"), 0.4)),
             shape = "circle filled") +
  geom_smooth(method = "loess",
              formula = y ~ x,
              span = 0.2,
              colour = su_theme_cols("orange"),
              fill = NA) +
  scale_x_proximity_to_death_days(months_every = 3) +
  scale_y_continuous(labels = percent,
                     position = "right",
                     breaks = seq(0, 1, 0.1)) +
  expand_limits(y = 0) +
  theme(panel.grid.major = element_line(linetype = "dashed",
                                        colour = "lightgrey"),
        axis.title.y.right = element_text(margin = margin(l = 10))) +
  labs(x = "Proximity to Death (Months)",
       y = "% of Spend that is Specialised Services")
```

## cumulative percentage spend

```{r}
activity_costs %>%
  filter(pod_type != "Bed") %>%
  group_by(proximity_to_death_days) %>%
  summarise_at("cost", sum) %>%
  arrange(-proximity_to_death_days) %>%
  mutate_at("cost", cumsum) %>%
  mutate_at("cost", ~.x / max(.x)) %>%
  ggplot(aes(proximity_to_death_days, cost)) +
  geom_step() +
  scale_x_proximity_to_death_days(expand = expansion(c(0.02, 0)),
                                  minor_breaks = seq(0, 2*365, 365/12),
                                  months_every = 3) +
  scale_y_continuous(labels = percent,
                     expand = expansion(),
                     breaks = seq(0, 1, 0.2),
                     position = "right") +
  theme(panel.grid = element_line(linetype = "dashed",
                                  colour = "lightgrey"),
        axis.title.y.right = element_text(margin = margin(l = 10))) +
  labs(x = "Proximity to Death (Months)",
       y = "Cumulative Percentage of Spend")
```

# % of spend by % of patients

ordered such that highest "cost" patients are at the left, lowest "cost" are on
the right.

```{r}
df <- activity_costs %>%
  filter(ss_flag %in% c("Spec. Services", "CCG"),
         pod_type != "Bed")

list(
  data = list(group_by(df, ss_flag, su_pat_id),
              group_by(df, ss_flag, pod_type, su_pat_id)),
  facet = list(NULL,
               facet_wrap(vars(pod_type), scales = "free_x"))
) %>%
  pmap(function(data, facet) {
    data %>%
      summarise_at("cost", sum) %>%
      complete(su_pat_id = mpi$su_pat_id, fill = list(cost = 0)) %>%
      arrange(desc(cost)) %>%
      mutate(cumcost = cumsum(cost)) %>%
      mutate_at("cumcost", ~.x / max(.x)) %>%
      mutate(row = row_number() / n()) %>%
      #filter(cost > 0) %>%
      ggplot(aes(row, cumcost, colour = ss_flag)) +
      geom_step() +
      scale_x_continuous(labels = percent, n.breaks = 5) +
      scale_y_continuous(labels = percent, n.breaks = 5) +
      labs(x = "% of All Patients",
           y = "% of Spend",
           colour = "") +
      geom_abline(slope = 1) +
      theme(panel.grid = element_line(linetype = "dotted",
                                      colour = "lightgrey"),
            legend.position = c(1, 0),
            legend.justification = c(1, 0),
            legend.background = element_blank(),
            legend.key = element_blank()) +
      facet
  }) %>%
  walk(plot)
```

```{r}
gini_df <- df %>%
  filter(cost > 0) %>%
  mutate_at("pod_type", fct_drop) %>%
  group_by(pod_type, su_pat_id) %>%
  summarise_at("cost", sum) %>%
  complete(pod_type,
           su_pat_id = mpi$su_pat_id,
           fill = list(cost = 0)) %>%
  arrange(desc(cost)) %>%
  mutate(cumcost = cumsum(cost)) %>%
  mutate_at("cumcost", ~.x / max(.x)) %>%
  mutate(row = row_number() / n(),
         gini = Gini(cost),
         gini_label = ifelse(row == min(row),
                             paste0("gini = ", number(gini, 0.001)),
                             NA)) %>%
   filter(cost > 0)



list(
  gini_df %>% filter(pod_type == "Urgent Service Event"),
  gini_df %>% filter(pod_type != "Urgent Service Event")
) %>%
  map(function(data) {
    gini_df_end <- data %>%
      filter(max(cumcost) == cumcost)
    
    data %>%
      mutate_at("pod_type", fct_drop) %>%
      ggplot(aes(row, cumcost)) +
      geom_step() +
      scale_x_continuous(labels = percent, n.breaks = 5) +
      scale_y_continuous(labels = percent, n.breaks = 5) +
      labs(x = "% of All Patients",
           y = "% of Spend",
           colour = "") +
      geom_segment(data = gini_df_end,
                   aes(xend = row, yend = 0)) +
      geom_segment(data = gini_df_end,
                   aes(xend = 1, yend = 1)) +
      geom_point(data = gini_df_end,
                 shape = "circle filled",
                 colour = "black",
                 fill = "white") +
      geom_label(aes(x = 1, y = 0, label = gini_label),
                 na.rm = TRUE,
                 hjust = "right",
                 vjust = "bottom",
                 size = 3,
                 label.size = 0) +
      geom_abline(slope = 1, linetype = "dashed") +
      theme(legend.position = c(1, 0),
            legend.justification = c(1, 0),
            legend.background = element_blank(),
            legend.key = element_blank()) +
      facet_wrap(vars(pod_type), scales = "free_x")
  }) %>%
  walk(plot)
```

# Forecast Specialised Services Spend

```{r}
average_costs_per_person <- activity_costs %>%
  filter(ss_flag == "Spec. Services", pod_type != "Bed") %>%
  inner_join(mpi, by = "su_pat_id") %>%
  mutate_at("age", pmin, 90) %>%
  mutate(activity_year = as.numeric(proximity_to_death_days >= 365)) %>%
  group_by(activity_year, pod_type, age, sex) %>%
  summarise(cost = sum(cost), .groups = "drop") %>%
  complete(nesting(pod_type),
           activity_year = 0:1,
           age = seq(18, 90),
           sex,
           fill = list(cost = 0)) %>%
  inner_join(count(mpi, age, sex, name = "decedents"), by = c("age", "sex"))

plots <- average_costs_per_person %>%
  mutate_at("age", ~case_when(.x > 90 ~ 90,
                              .x < 50 ~ 50,
                              TRUE ~ .x)) %>%
  group_by(pod_type, activity_year, age) %>%
  summarise(avg_cost = sum(cost) / sum(decedents), .groups = "drop") %>%
  group_nest(pod_type) %>%
  pmap(function(pod_type, data) {
    data %>%
      mutate_at("activity_year",
                ifelse,
                "Second year period (12-24 months before death)",
                "First year period (0-12 months before death)") %>%
      ggplot(aes(age, avg_cost, colour = activity_year)) +
      geom_smooth(fill = NA, method = "loess", formula = y ~ x, na.rm = TRUE,
                  lwd = 0.75) +
      geom_point(na.rm = TRUE) +
      expand_limits(y = 0) +
      scale_y_continuous(labels = comma_format(prefix = "£")) +
      theme(legend.position = "bottom") +
      labs(title = pod_type, colour = "", y = "Average Spend Per Person")
  })

reduce(plots[1:3], `+`) / guide_area() + plot_layout(guides = 'collect', heights = c(10, 1))
reduce(plots[4:6], `+`) / guide_area() + plot_layout(guides = 'collect', heights = c(10, 1))
```

```{r}
average_costs_per_person_sum <- forecast_deaths %>%
  inner_join(average_costs_per_person, by = c("sex", "age_group" = "age")) %>%
  mutate_at("year", ~.x - activity_year) %>%
  filter(!year %% 5) %>%
  filter(age_group >= 18) %>%
  mutate_at("age_group",
            cut,
            c(0, 18, 65, 75, 85, Inf),
            labels = levels(mpi$age_band),
            right = FALSE) %>%
  group_by(year, age_group, pod_type) %>%
  summarise(across(c("est_deaths", "cost", "decedents"), sum), .groups = "drop_last")

bind_rows(
  average_costs_per_person_sum,
  average_costs_per_person_sum %>%
    group_by(est_deaths, decedents, add = TRUE) %>%
    summarise_at("cost", sum) %>%
    mutate(pod_type = "All Activity")
) %>%
  ungroup() %>%
  mutate_at("pod_type",
            fct_relevel,
            c("All Activity",
              levels(activity_costs$pod_type) %>% subset(., . != "Bed"))) %>%
  mutate(cost = ifelse(decedents, cost / decedents * est_deaths, 0)) %>%
  group_nest(pod_type) %>%
  pmap(function(pod_type, data) {
    lbls <- data %>%
      group_by(year) %>%
      summarise_at("cost", sum) %>%
      arrange(year) %>%
      mutate(act_sum_lbl = comma(cost, accuracy = 1, prefix = "£"),
             pcnt_change_lbl = percent(ifelse(year == 2020,
                                              NA,
                                              cost / first(cost) - 1),
                                       accuracy = .1))
  
    data %>%
      ggplot(aes(year, cost)) +
      geom_col(aes(fill = fct_rev(age_group)),
               alpha = 0.4,
               colour = "white",
               position = "stack") +
      geom_text(data = lbls, aes(label = act_sum_lbl), vjust = -.3, size = 3.5, na.rm = TRUE) +
      geom_text(data = lbls, aes(label = pcnt_change_lbl), vjust = 1.3, size = 3.5, na.rm = TRUE) +
      scale_fill_discrete(guide = guide_legend(reverse = TRUE),
                          reverse = TRUE) +
      scale_y_continuous(labels = comma_format(prefix = "£", scale = 1e-6, suffix = "m"),
                         expand = expansion(c(0, 0.15))) +
      labs(fill = "",
           y = "Specialist Services Spend",
           title = pod_type) +
      theme(legend.position = "bottom")
  }) %>%
  walk(plot)
```

[//]: <> (URL's / References --------------------------------------------------)
[su_email]: mailto:Strategy.Unit@nhs.net
[su_web]: https://www.strategyunitwm.nhs.uk/
