---
title: "End of Life"
author: '[T. Jemmett](mailto:thomas.jemmett@nhs.net)'
date: "25/11/2019"
output:
  StrategyUnitTheme::su_document:
    toc: yes
  word_document:
    reference_docx: su_template.docx
    #toc: true
  html_document:
    fig_caption: true
    toc: true
    toc_float: true
params:
  stp: "E54000016"
  region_report: true
---

```{r setup, include=FALSE}
library(knitr)
# knitr options ----
opts_chunk$set(echo = FALSE, eval.after = "fig.cap")

if (!knitr::is_latex_output()) {
  opts_chunk$set(dpi = 300,
                 dev.args = list(type = "cairo"))
}

# all setup should happen in setup.R that could be shared logic between files
invisible(local({
  source("setup.R")
  load_data(params$stp, params$region_report)
}))
```

This report is about the people in `r stp_name` STP who died between April 2018
and March 2019 and were 18 years or older at their date of death.

Comparisons are made between this STP and the others `r nrow(region)`
in the `r region_name`.

# Place of death

```{r place of death by cause of death mekko}
mpi %>%
  filter(location_type != "Unknown",
         group != "(Missing)") %>%
  mutate_at(vars(group),
            compose(fct_rev, fct_recode),
            "Sudden\nDeath" = "Sudden Death",
            "OTI" = "Other Terminal Illness") %>%
  mekko_chart(group, location_type) +
  place_of_death_fill() 
```
OTI = Other Terminal Illness

```{r place of death by deprivation mekko}
mpi %>%
  filter(location_type != "Unknown",
         !is.na(imd_quintile)) %>%
  mutate_at("imd_quintile",
            compose(.dir = "forward",
              as.factor,
              partial(fct_recode,
                      "Most Deprived" = "1",
                      # we still need unique labels, so let's just increase the
                      # number of spaces each time
                      " " = "2", 
                      "  " = "3",
                      "   " = "4",
                      "Least Deprived" = "5")
              )) %>%
  mekko_chart(imd_quintile, location_type) +
  place_of_death_fill()
```

```{r place of death by gender}
mpi %>%
  filter(location_type != "Unknown") %>%
  mekko_chart(sex, location_type) +
  place_of_death_fill()
```

```{r ethnicity place of death, message=FALSE, warning=FALSE}
local({
  data <- mpi %>%
    filter(ethnic_group != "Unknown")
  
  if (nrow(data) > 0) {
    data %>%
      count(ethnic_group, location_type, age_band) %>%
      filter(location_type != "Unknown") %>%
      group_by(ethnic_group, age_band) %>%
      mutate_at("n", ~.x/sum(.x)) %>%
      ggplot(aes(ethnic_group, n)) +
      geom_col(aes(fill = location_type),
               alpha = 0.4,
               colour = "white") +
      scale_y_continuous(labels = percent) +
      place_of_death_fill(reverse = TRUE) +
      facet_wrap(vars(age_band)) +
      coord_flip() +
      theme(legend.position = "bottom") +
      labs(x = "", y = "", fill = "")
  } else {
    warning("Ethnicity is missing: plot not run")  
  }
})
```

# About Peoples' Healthcare

## Activity types per person

```{r activity pcnt}
local({
  p <- list(
    stp = activity,
    region = activity_region
  ) %>%
    map_dfr(.id = "type", function(.x) {
      .x %>%
        mutate_at("pod_type",
                  ~ifelse(pod_summary_group == "Critical Care Bed Day",
                          "Critical Care Bed Day",
                          as.character(.x))) %>%
        group_by(pod_type) %>%
        distinct(su_pat_id) %>%
        count() %>%
        ungroup() %>%
        mutate_at("pod_type",
                  fct_relevel,
                  c(levels(activity$pod_type), "Critical Care Bed Day"))
    }) %>%
    inner_join(
      bind_rows(
        mpi %>%
          summarise(patients = n_distinct(su_pat_id)) %>%
          mutate(type = "stp"),
        
        mpi_region %>%
          summarise(patients = n_distinct(su_pat_id)) %>%
          mutate(type = "region"),
      ),
      by = c("type")
    ) %>%
    mutate_at("n", ~.x / patients) %>%
    select(-patients) %>%
    pivot_wider(names_from = "type", values_from = "n") %>%
    filter(pod_type != "Bed") %>%
    ggplot(aes(pod_type, stp)) +
    geom_col(aes(colour = pod_type,
                 fill = after_scale(alpha(colour, 0.4)))) +
    scale_y_continuous(labels = percent,
                       expand = expansion(c(0.06, 0.05))) +
    expand_limits(y = c(0, 1)) +
    labs(x = "", y = "", colour = "", fill = "")  +
    theme(legend.position = "none",
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank())
  
  if (!params$region_report) {
    p <- p +
      geom_point(aes(y = region,
                     colour = pod_type,
                     fill = after_scale(alpha(colour, 0.4))),
                 show.legend = FALSE,
                 size = 2,
                 shape = "circle filled",
                 stroke = 1.5) 
  }
  
  p + geom_text(aes(y = 0, label = percent(stp, accuracy = 1)),
                size = 3.5,
                vjust = 1.35)
})
```

```{r activity pcnt pod summary group}
local({
  p <- list(
    stp = activity,
    region = activity_region
  ) %>%
    map_dfr(.id = "type", function(.x) {
      .x %>%
        group_by(pod_type, pod_summary_group, cc_pod_summary_group) %>%
        distinct(su_pat_id) %>%
        count() %>%
        ungroup() %>%
        mutate_at("pod_type",
                  ~ifelse(pod_summary_group == "Critical Care Bed Day",
                          "Critical Care Bed Day",
                          as.character(.x))) %>%
        mutate_at("pod_summary_group",
                  ~ifelse(pod_type == "Critical Care Bed Day",
                          paste0("Critical Care (",
                                 word(cc_pod_summary_group, 1),
                                 ")"),
                          as.character(pod_summary_group))) %>%
        mutate_at("pod_summary_group",
                  fct_relevel,
                  levels(activity$pod_summary_group) %>%
                    subset(., . != "Critical Care Bed Day"),
                  "Critical Care (Emergency)",
                  "Critical Care (Elective)")
    }) %>%
    inner_join(
      bind_rows(
        mpi %>%
          summarise(patients = n_distinct(su_pat_id)) %>%
          mutate(type = "stp"),
        
        mpi_region %>%
          summarise(patients = n_distinct(su_pat_id)) %>%
          mutate(type = "region"),
      ),
      by = c("type")
    ) %>%
    mutate_at("n", ~.x / patients) %>%
    select(-patients) %>%
    pivot_wider(names_from = "type", values_from = "n") %>%
    filter(pod_type != "Bed") %>% 
    ungroup() %>%
    mutate_at("pod_type",
              fct_relevel,
              c(levels(activity$pod_type) %>% subset(., . != "Bed"),
                "Critical Care Bed Day")) %>%
    ggplot(aes(pod_summary_group, stp)) +
    geom_col(aes(colour = pod_type,
                 fill = after_scale(alpha(colour, 0.4)))) +
    scale_x_discrete(labels = partial(str_wrap, width = 10)) +
    scale_y_continuous(labels = percent,
                       expand = expansion(c(0.06, 0.05))) +
    expand_limits(y = c(0, 1)) +
    labs(x = "", y = "", colour = "", fill = "")  +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1),
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank())
  
  
  if (!params$region_report) {
    p <- p +
      geom_point(aes(y = region,
                     colour = pod_type,
                     fill = after_scale(alpha(colour, 0.4))),
                 show.legend = FALSE,
                 size = 2,
                 shape = "circle filled",
                 stroke = 1.5) 
  }
  
  p + geom_text(aes(y = 0, label = percent(stp, accuracy = 1)),
                size = 3.5,
                vjust = 1.35)
})
```

```{r activity pcnt cod}
local({
  p <- list(
    stp = activity %>%
      inner_join(select(mpi, su_pat_id, group), by = "su_pat_id"),
    region = activity_region %>%
      inner_join(select(mpi_region, su_pat_id, group), by = "su_pat_id")
  ) %>%
    map_dfr(.id = "type", function(.x) {
      .x %>%
        mutate_at("pod_type",
                  ~ifelse(pod_summary_group == "Critical Care Bed Day",
                          "Critical Care Bed Day",
                          as.character(.x))) %>%
        group_by(pod_type, group) %>%
        distinct(su_pat_id) %>%
        count() %>%
        ungroup() %>%
        mutate_at("pod_type",
                  fct_relevel,
                  c(levels(activity$pod_type), "Critical Care Bed Day"))
    }) %>%
    inner_join(
      bind_rows(
        mpi %>%
          group_by(group) %>%
          summarise(patients = n_distinct(su_pat_id), .groups = "drop") %>%
          mutate(type = "stp"),
        
        mpi_region %>%
          group_by(group) %>%
          summarise(patients = n_distinct(su_pat_id), .groups = "drop") %>%
          mutate(type = "region"),
      ),
      by = c("type", "group")
    ) %>%
    mutate_at("n", ~.x / patients) %>%
    select(-patients) %>%
    pivot_wider(names_from = "type", values_from = "n") %>%
    filter(group != "(Missing)",
           pod_type != "Bed") %>%
    mutate_at("group",
              fct_recode,
              "OTI" = "Other Terminal Illness") %>%
    ggplot(aes(pod_type, stp)) +
    geom_col(aes(colour = group,
                 fill = after_scale(alpha(colour, 0.4))),
             position = position_dodge(width = 0.8),
             width = 0.8) +
    scale_y_continuous(labels = percent,
                       expand = expansion(c(0, 0.05))) +
    expand_limits(y = c(0, 1)) +
    labs(x = "", y = "", colour = "", fill = "") +
    theme(legend.position = "bottom",
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank())
  
  
  if (!params$region_report) {
    p <- p  +
      geom_point(aes(y = region,
                     colour = group,
                     fill = after_scale(alpha(colour, 0.4))),
                 show.legend = FALSE,
                 shape = "circle filled",
                 size = 2,
                 stroke = 1.5,
                 position = position_dodge(width = .8))
  }
  
  p
})
```

# Forecast Activity

```{r forecast deaths}
forecast_deaths %>%
  mutate(age = age_group) %>%
  mutate_at("age_group",
            cut,
            breaks = c(0,18,65,75,85,Inf),
            labels = c("0-17", "18-64","65-74","75-85","85+"),
            right = FALSE) %>%
  arrange(age_group, year) %>%
  group_by(age_group, year) %>%
  filter(year >= 2020) %>%
  summarise_at("est_deaths", sum) %>%
  mutate(first_year = ifelse(year == min(year),
                             comma(est_deaths, accuracy = 1),
                             NA),
         last_year  = ifelse(year == max(year),
                             paste0(comma(est_deaths, accuracy = 1),
                                    " (",
                                    percent(est_deaths / first(est_deaths) - 1,
                                           accuracy = 1),
                                   ")"),
                             NA)) %>%
  ungroup() %>%
  ggplot(aes(year, est_deaths, colour = age_group)) +
  geom_line(linetype = "dashed") +
  geom_text_repel(aes(year-1, est_deaths, label = first_year),
                  na.rm = TRUE,
                  direction = "y",
                  hjust = 1,
                  size = 3,
                  segment.colour = NA,
                  point.padding = NA,
                  show.legend = FALSE) +
  geom_text_repel(aes(year+1, est_deaths, label = last_year),
                  na.rm = TRUE,
                  direction = "y",
                  hjust = 0,
                  size = 3,
                  segment.colour = NA,
                  point.padding = NA,
                  show.legend = FALSE) +
  labs(colour = "",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2020, 2040, 5),
                     expand = expansion(c(0.10, 0.15))) +
  scale_colour_manual(values = su_theme_cols("slate",
                                             "orange",
                                             "charcoal",
                                             "blue",
                                             "red") %>% unname()) +
  scale_y_continuous(labels = comma) +
  theme(legend.position = "bottom",
        legend.key = element_blank())
``` 

```{r forecast activity 5 year bars table}
forecast_data <- forecast_activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  filter(year %% 5 == 0) %>%
  group_by(age_band, year, pod_type) %>%
  summarise_at(vars(est_deaths, activity), sum) %>%
  ungroup()

forecast_data %>%
  filter(pod_type == "Bed") %>%
  group_by(year) %>%
  summarise(across(activity, sum), .groups = "drop") %>%
  mutate(across(activity, ~round((.x - first(.x)) / (365*.9)))) %>%
  filter(year > 2020) %>%
  pivot_wider(names_from = year, values_from = activity) %>%
  mutate(type = "Extra Beds") %>%
  relocate(type, .before = everything())
```

```{r forecast activity 5 year bars plot, echo=FALSE, message=FALSE, results='hide'}

forecast_data %>%
  group_nest(pod_type) %>%
  pwalk(function(pod_type, data) {
    lbls <- data %>%
      group_by(year) %>%
      summarise_at("activity", sum) %>%
      arrange(year) %>%
      mutate(act_sum_lbl = comma(activity, accuracy = 1),
             pcnt_change_lbl = percent(ifelse(year == 2020,
                                              NA,
                                              activity / first(activity) - 1),
                                       accuracy = .1))
    
    p <- data %>%
      ggplot(aes(year, activity)) +
      geom_col(aes(fill = fct_rev(age_band)),
               alpha = 0.4,
               colour = "white",
               position = "stack") +
      geom_text(data = lbls, aes(label = act_sum_lbl), vjust = -.3, na.rm = TRUE) +
      geom_text(data = lbls, aes(label = pcnt_change_lbl), vjust = 1.3, size = 3.5, na.rm = TRUE) +
      scale_y_continuous(labels = scales::comma_format(scale = .001),
                         expand = expansion(c(0, 0.15))) +
      scale_fill_discrete(guide = guide_legend(reverse = TRUE),
                          reverse = TRUE) +
      labs(fill = "",
           y = "Activity (1,000's)",
           title = pod_type) +
      theme(legend.position = "bottom")
    plot(p)
  })
```

# Death Comparison Charts

```{r pcnt_dot_comparison_plot}
pcnt_bar_comparison_plot <- function(mpi, category, value, reorder = TRUE) {
  data <- mpi %>%
    filter({{category}} != "(Missing)",
           !is.na({{category}})) %>%
    modify_at(vars({{value}}), replace_na, 0) %>%
    group_by({{category}}) %>%
    summarise_at(vars({{value}}), mean, na.rm = TRUE)
    
  if (reorder) {
    data <- mutate_at(data,
                      vars({{category}}),
                      fct_reorder,
                      quo({{value}}))
  }
    
  data %>%
    ggplot(aes({{value}}, {{category}})) +
    geom_col(colour = su_theme_cols("orange"),
             fill = after_scale(alpha(su_theme_cols("orange"), 0.4))) +
    scale_x_continuous(labels = percent,
                       expand = expansion(c(0, 0.05))) +
    scale_y_discrete(expand = expansion()) +
    labs(x = "", y = "") +
    theme(axis.title.y = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank(),
          panel.grid.major.x = element_line(colour = "lightgrey",
                                            linetype = "dotted"))  
}

pcnt_dot_comparison_plot <- function(mpi, mpi_region, category, value, reorder = TRUE) {
  data <- bind_rows(
    mutate(mpi, type = stp_name),
    mutate(mpi_region, type = region_name)
  ) %>%
    filter({{category}} != "(Missing)",
           !is.na({{category}})) %>%
    mutate_at(vars({{value}}), replace_na, 0) %>%
    group_by({{category}}, type) %>%
    summarise(numerator = sum({{value}}),
              denominator = n(),
              .groups = "drop_last") %>%
    ungroup() %>%
    arrange(type == region_name) %>%
    mutate_at(vars(type), fct_relevel, stp_name, region_name) %>%
    mutate(x = map2(numerator, denominator,
                    compose(as_tibble, BinomCI))) %>%
    unnest(cols = c(x)) %>%
    rename({{value}} := est) %>%
    mutate_at(vars(lwr.ci, upr.ci), ~ifelse(type == region_name, NA, .x))
  
  if (reorder) {
    data <- mutate_at(data,
                      vars({{category}}),
                      fct_reorder,
                      quo({{value}}))
  }
  
  ggplot(data, aes({{category}}, {{value}}, fill = type)) +
    geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci),
                  na.rm = TRUE,
                  width = 0.2) +
    geom_point(aes(size = type), shape = "circle filled") +
    coord_flip() +
    scale_size_manual(values = c(5, 2)) +
    scale_fill_manual(values = su_theme_cols()[c("orange", "slate")] %>%
                        unname()) +
    scale_y_continuous(labels = percent_format(accuracy = 1),
                       expand = expansion(mult = c(0, 0.05))) +
    expand_limits(y = 0) +
    theme(axis.line = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid.major.x = element_line(colour = "grey",
                                            linetype = "dotted"),
          legend.position = c(1, 0),
          legend.justification = c(1, 0),
          legend.direction = "horizontal") +
    labs(x = "", y = "", fill = "", size = "")
}
```

```{r died in critical care - group}
pcnt_bar_comparison_plot(mpi, group, died_in_critical_care) +
  xlab("% who died in critical care")

pcnt_dot_comparison_plot(mpi, mpi_region, group, died_in_critical_care) +
  ylab("% who died in critical care")
```

```{r died in critical care - age}
pcnt_bar_comparison_plot(mpi, age_band, died_in_critical_care) +
  xlab("% who died in critical care")

pcnt_dot_comparison_plot(mpi, mpi_region, age_band, died_in_critical_care) +
  ylab("% who died in critical care")
```

```{r died in critical care - imd}
# suppress "Scale for 'y' is already present" message
suppressMessages(
  mpi %>%
    mutate_at("imd_quintile", factor, levels = as.character(5:1)) %>%
    pcnt_bar_comparison_plot(imd_quintile, died_in_critical_care) +
    scale_y_discrete(labels = c("Least Deprived","","","","Most Deprived")) +
    ylab("% who died in critical care")
)

local({
  mpi <- mpi %>%
    mutate_at("imd_quintile", factor, levels = as.character(5:1))
  
  mpi_region <- mpi_region %>%
    mutate_at("imd_quintile", factor, levels = as.character(5:1))
  
  pcnt_dot_comparison_plot(mpi, mpi_region, imd_quintile, died_in_critical_care, FALSE) +
    ylab("% who died in critical care") +
    scale_x_discrete(labels = c("Least Deprived","","","","Most Deprived")) +
    theme(legend.position = c(0.001, 0),
          legend.justification = c(0, 0))
})
```

```{r had critical care - group}
mpi %>%
  mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care))) %>%
  pcnt_bar_comparison_plot(group, had_critical_care) +
  xlab("% who had critical care")

local({
  mpi <- mpi %>%
    mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care)))
                
  mpi_region <- mpi_region %>%
    mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care)))
                
  pcnt_dot_comparison_plot(mpi, mpi_region, group, had_critical_care) +
    ylab("% who had critical care")
})
```

```{r had critical care - age}
mpi %>%
  mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care))) %>%
  pcnt_bar_comparison_plot(age_band, had_critical_care) +
  xlab("% who had critical care")

local({
  mpi <- mpi %>%
    mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care)))
                
  mpi_region <- mpi_region %>%
    mutate(had_critical_care = as.numeric(!is.na(died_in_critical_care)))
                
  pcnt_dot_comparison_plot(mpi, mpi_region, age_band, had_critical_care) +
    ylab("% who had critical care")
})
```

```{r percentage lives alone}
mpi %>%
  drop_na(lives_alone) %>%
  pcnt_bar_comparison_plot(group, lives_alone) +
  xlab("% who lived alone")

pcnt_dot_comparison_plot(drop_na(mpi, lives_alone),
                         drop_na(mpi_region, lives_alone),
                         group,
                         lives_alone) +
  ylab("% who lived alone")
```

```{r percentage carer support}
mpi %>%
  mutate_at("carer_support", ~.x == "01") %>%
  pcnt_bar_comparison_plot(group, carer_support) +
  ylab("% who had carer support")

pcnt_dot_comparison_plot(mpi %>%
                           mutate_at("carer_support", ~.x == "01"),
                         mpi_region %>%
                           mutate_at("carer_support", ~.x == "01"),
                         group, carer_support) +
  ylab("% who had carer support")
```

```{r historic and forecast deaths}
list(
  historic = historical_deaths %>%
    select(-stp) %>%
    mutate(point_val = deaths),
  forecast = forecast_deaths %>%
    group_by(year, sex) %>%
    summarise_at("est_deaths", sum) %>%
    rename(deaths = est_deaths) %>%
    filter(year > 2019)
) %>%
  bind_rows(.id = "type") %>%
  mutate_at("type", fct_rev) %>%
  ggplot(aes(year, deaths, colour = sex)) +
  geom_line(aes(linetype = type)) +
  geom_point(aes(y = point_val), na.rm = TRUE, show.legend = FALSE) +
  scale_x_continuous(breaks = seq(2010, 2040, 5)) +
  scale_y_continuous(labels = comma_format(accuracy = 1)) +
  scale_linetype_manual(values = c("forecast" = "dashed",
                                   "historic" = "solid")) +
  labs(colour = "gender", x = "", y = "") +
  theme(legend.position = c(1, 0),
        legend.justification = c(1, 0),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank())
```

# Utilisation

```{r utilisation curve, message=FALSE,  echo=FALSE, results = "none"}
utilisation_curve_plot <- function(pod_type, data, loess_span = 0.15) {
  p <- data %>%
    ggplot(aes(proximity_to_death_days, stp)) +
    geom_smooth(span = loess_span,
                formula = y ~ x,
                method = "loess",
                fill = NA,
                colour = su_theme_cols()[["orange"]])
  
  if (!params$region_report) {
    p <- p + 
      geom_smooth(aes(y = region),
                span = loess_span,
                formula = y ~ x,
                method = "loess",
                fill = NA,
                colour = after_scale(alpha(su_theme_cols()[["charcoal"]], 0.4)))
  }
  
  p +
    geom_point(size = 0.2,
               shape = "circle filled",
               colour = su_theme_cols()[["orange"]],
               fill = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
    
    geom_vline(xintercept = 3*365/12,
               linetype = "dashed",
               colour = su_theme_cols()[["dark_charcoal"]]) +
    scale_x_proximity_to_death_days() +
    scale_y_continuous(sec.axis = dup_axis(labels = comma_format(scale = 1000,
                                                                 accuracy = 1),
                                           name = "Activity per 1,000 Decedants")) +
    theme(panel.grid.major = element_line(colour = "grey",
                                          size = 0.25,
                                          linetype = "dotted"),
          axis.text.y.left = element_blank(),
          axis.title.y.right = element_text(margin = margin(0, 0, 0, 10)),
          axis.ticks.y.left = element_blank(),
          legend.position = "bottom") +
    labs(title = ifelse(pod_type == "Bed", "Bed Days", as.character(pod_type)),
         x = "Proximity to Death (Months)",
         y = "",
         colour = "") +
    annotate("text",
             x = 3*365/12+10,
             y = max(c(data$stp, data$region)),
             label = "3 months prior to death",
             hjust = 1,
             size = 3)
}

list(
  stp = activity,
  region = activity_region
) %>%
  map_dfr(.id = "type", function(.x) {
    .x %>%
      mutate_at("pod_type",
                ~ifelse(pod_summary_group == "Critical Care Bed Day",
                        "Critical Care Bed Day",
                        as.character(.x))) %>%
      mutate_at("pod_type",
                fct_relevel,
                c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
      count(pod_type, proximity_to_death_days)
  }) %>%
  inner_join(tribble(~type, ~p,
                     "stp", nrow(mpi),
                     "region", nrow(mpi_region)),
             by = "type") %>%
  mutate_at("n", ~n / p) %>%
  select(-p) %>%
  pivot_wider(names_from = type, values_from = n) %>%
  modify_at(vars(region, stp), replace_na, 0) %>%
  group_nest(pod_type) %>%
  mutate(loess_span = c(0.05, 0.15, 0.15, 0.05, 0.05)) %>% 
  pmap(utilisation_curve_plot) %>%
  walk(plot)
```

```{r utilisation curve grouped, message=FALSE,  echo=FALSE, results = "none"}
utilisation_curve_plot_grouped <- function(pod_type, data, loess_span = 0.15) {
  data %>%
    ggplot(aes(proximity_to_death_days, n, colour = group)) +
    geom_smooth(span = loess_span,
                formula = y ~ x,
                method = "loess",
                size = 0.5,
                fill = NA) +
    geom_vline(xintercept = 3*365/12,
               linetype = "dashed",
               colour = su_theme_cols()[["dark_charcoal"]]) +
    scale_x_proximity_to_death_days() +
    scale_y_continuous(sec.axis = dup_axis(labels = comma_format(scale = 1000,
                                                                 accuracy = 1),
                                           name = "Activity per 1,000 Decedants")) +
    theme(panel.grid.major = element_line(colour = "grey",
                                          size = 0.25,
                                          linetype = "dotted"),
          axis.text.y.left = element_blank(),
          axis.title.y.right = element_text(margin = margin(0, 0, 0, 10)),
          axis.ticks.y.left = element_blank(),
          legend.position = "bottom") +
    labs(title = ifelse(pod_type == "Bed", "Bed Days", as.character(pod_type)),
         x = "Proximity to Death (Months)",
         y = "",
         colour = "") +
    annotate("text",
             x = 3*365/12+10,
             y = max(data$n),
             label = "3 months prior to death",
             hjust = 1,
             size = 3)
}

activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(group != "(Missing)") %>%
  count(pod_type, group, proximity_to_death_days) %>%

  inner_join(count(mpi, group, name = "p"), by = "group") %>%
  mutate_at("n", ~n/p) %>%
  
  group_nest(pod_type) %>%
  mutate(loess_span = c(0.05, 0.15, 0.15, 0.05, 0.05)) %>% 
  pmap(utilisation_curve_plot_grouped) %>%
  walk(plot)
```

```{r utilisation curve location, message=FALSE,  echo=FALSE, results = "none"}
activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>% 
  inner_join(select(mpi, su_pat_id, group = location_type),
             by = "su_pat_id") %>%
  filter(group != "Unknown") %>%
  count(pod_type, group, proximity_to_death_days) %>%
  
  inner_join(count(mpi, group = location_type, name = "p"), by = "group") %>%
  mutate_at("n", ~n/p) %>%
  
  group_nest(pod_type) %>%
  pmap(utilisation_curve_plot_grouped) %>%
  walk(plot)
```

### Utilisation Rates

```{r utilisation rates, message=FALSE,  echo=FALSE, results = "none"}
list(stp = activity,
     region = activity_region) %>%
  map_dfr(.id = "type", function(.x) {
    .x %>%
      inner_join(select(mpi_region, su_pat_id, age),
                 by = "su_pat_id") %>%
    mutate(activity_year = as.numeric(proximity_to_death_days >= 365)) %>%
    mutate_at("age", ~case_when(.x > 90 ~ 90,
                                .x < 50 ~ 50,
                                TRUE ~ .x)) %>%
    mutate_if(is.factor, as.character) %>%
    count(pod_type, pod_summary_group, activity_year, age,
          name = "activity")
  }) %>%
  arrange(type, pod_type, pod_summary_group, activity_year, age) %>%
  complete(nesting(pod_type, pod_summary_group),
           activity_year = 0:1,
           age = seq(50, 90),
           fill = list(activity = 0)) %>%
  inner_join(
    bind_rows(
      mpi %>%
        mutate_at("age",
                  ~case_when(.x > 90 ~ 90,
                             .x < 50 ~ 50,
                             TRUE ~ .x)) %>%
        count(age, name = "deaths") %>%
        mutate(type = "stp"),
      mpi_region %>%
        mutate_at("age",
                  ~case_when(.x > 90 ~ 90,
                             .x < 50 ~ 50,
                             TRUE ~ .x)) %>%
        count(age, name = "deaths") %>%
        mutate(type = "region")
    ),
    by = c("type", "age")
  ) %>%
  mutate(utilisation = activity / deaths) %>%
  select(-activity, -deaths) %>%
  pivot_wider(names_from = "type", values_from = "utilisation") %>%
  group_nest(pod_type) %>%
  pmap(function(pod_type, data) {
    data %>%
      mutate_at("pod_summary_group",
                ~fct_reorder(.x, region, .fun = sum)) %>%
      mutate_at("activity_year",
                ifelse,
                "Second year period (12-24 months before death)",
                "First year period (0-12 months before death)") %>%
      ggplot(aes(age, stp, colour = activity_year)) +
      geom_smooth(fill = NA, method = "loess", formula = y ~ x, na.rm = TRUE,
                  lwd = 0.75) +
      geom_smooth(aes(y = region, group = activity_year),
                  fill = NA, method = "loess", formula = y ~ x, na.rm = TRUE,
                  alpha = 0.4, linetype = "dashed",
                  lwd = 0.75) +
      geom_point(na.rm = TRUE) +
      expand_limits(y = 0) +
      facet_wrap(vars(fct_rev(pod_summary_group)), scales = "free") +
      theme(legend.position = "bottom") +
      labs(title = ifelse(pod_type == "Bed", "Bed Days", as.character(pod_type)),
           colour = "")
  }) %>%
  walk(plot)
```

# Critical Care LoS

```{r critical care LoS boxplot cod}
activity %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day",
         group != "(Missing)") %>%
  group_by(group) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(group, cc_los)) +
  geom_boxplot(aes(colour = group,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none",
        axis.title.x = element_blank()) +
  labs(x = "", y = "Critical Care Bed Days")
```

```{r critical care LoS boxplot age}
activity %>%
  inner_join(select(mpi, su_pat_id, age_band), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day") %>%
  group_by(age_band) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(fct_rev(age_band), cc_los)) +
  geom_boxplot(aes(colour = age_band,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Critical Care Bed Days")
```

```{r critical care LoS boxplot died}
activity %>%
  filter(pod_summary_group == "Critical Care Bed Day") %>%
  mutate_at("died_in_critical_care", ~ifelse(.x, "Yes", "No")) %>%
  group_by(group = died_in_critical_care) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(group, cc_los)) +
  geom_boxplot(aes(colour = group,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none") +
  labs(x = "Died in Critical Care?", y = "Critical Care Bed Days")
```

```{r critical care LoS boxplot died cod}
activity %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day",
         group != "(Missing)") %>%
  mutate_at("died_in_critical_care", ~ifelse(.x, "Yes", "No")) %>%
  group_by(group, died_in_critical_care) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(died_in_critical_care, cc_los)) +
  geom_boxplot(aes(colour = group,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none") +
  facet_wrap(vars(group), ncol = 1) +
  labs(x = "Died in Critical Care?",
       y = "Critical Care Bed Days")
```

```{r critical care LoS boxplot admission type}
activity %>%
  filter(pod_summary_group == "Critical Care Bed Day") %>%
  group_by(group = cc_pod_summary_group) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(group, cc_los)) +
  geom_boxplot(aes(colour = group,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  labs(y = "Critical Care Bed Days",
       x = "")
```

```{r critical care LoS boxplot age line}
activity %>%
  inner_join(select(mpi, su_pat_id, age), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day") %>%

  mutate_at("age",
            cut,
            c(18, seq(50, 90, 5), Inf),
            c("18-49",
              seq(50,85,5) %>% paste0(.,"-",.+4),
              "90+"),
            right = FALSE) %>%
  group_by(age) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  summarise_at("cc_los", list) %>%
  mutate(ci = map(cc_los, ~MeanCI(.x) %>% as.list() %>% as_tibble())) %>%
  
  mutate_at("cc_los", map, ~tibble(s = sum(.x), n = length(.x))) %>%
  unnest(cols = c(cc_los, ci)) %>%
  mutate(overall_mean = sum(s)/sum(n)) %>%
  ggplot(aes(age, mean)) +
  geom_hline(aes(yintercept = overall_mean),
             linetype = "dashed") +
  geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci)) +
  geom_point() +
  labs(x = "", y = "Mean Critical Care Bed Days")
```

```{r critical care LoS boxplot age line by cod, message = FALSE, echo = FALSE, results = "none"}
activity %>%
  inner_join(select(mpi, su_pat_id, age, group), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day",
         group != "(Missing)") %>%
  mutate_at("age",
            cut,
            c(18, seq(50, 90, 5), Inf),
            c("18-49",
              seq(50,85,5) %>% paste0(.,"-",.+4),
              "90+"),
            right = FALSE) %>%
  group_by(group, age) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  summarise_at("cc_los", list) %>%
  filter(map(cc_los, length) > 3) %>%
  mutate(ci = map(cc_los, ~MeanCI(.x) %>% as.list() %>% as_tibble())) %>%
  
  mutate_at("cc_los", map, ~tibble(s = sum(.x), n = length(.x))) %>%
  unnest(cols = c(cc_los, ci)) %>%
  mutate(overall_mean = sum(s)/sum(n)) %>%
  group_nest() %>%
  filter(group != "(Missing)") %>%
  pmap(function(group, data) {
    data %>%
      ggplot(aes(age, mean)) +
      geom_hline(aes(yintercept = overall_mean),
                 linetype = "dashed") +
      geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci), na.rm = TRUE) +
      geom_point(na.rm = TRUE) +
      labs(title = group, x = "", y = "Mean Critical Care Bed Days") +
      theme(legend.position = "none")
  }) %>%
  walk(plot)
```

```{r critical care LoS boxplot group admission type}
activity %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day",
         group != "(Missing)") %>%
  group_by(group, cc_pod_summary_group) %>%
  count(bb5008_pseudo_apcs_ident_pseudo, name = "cc_los") %>%
  mutate(n = n()) %>%
  select(-bb5008_pseudo_apcs_ident_pseudo) %>%
  ggplot(aes(cc_pod_summary_group, cc_los)) +
  geom_boxplot(aes(colour = group,
                   fill = after_scale(alpha(colour, 0.4))),
               outlier.shape = NA) +
  scale_x_discrete(labels = compose(str_to_upper,
                                    partial(str_sub, start = 1, end = 2))) +
  scale_y_continuous(breaks = seq(0,30,3)) +
  coord_flip(ylim = c(0, 18)) +
  theme(legend.position = "none",
        axis.title.y = element_text(margin = margin(r = 10))) +
  facet_wrap(vars(group), ncol = 1) +
  labs (x = "Admission Method (EL=Elective, EM=Emergency)",
        y = "Critical Care Bed Days")
```

### Critical Care stay "Theographs"

Each "row" of data is a patient, with bars showing when that patient stayed on
critical care. Black bars are elective admissions, yellow bars are emergency
admissions.

Data is ordered so patients who died in critical care are at the top. The data
is then further ordered within the "died" and "did not die" in CC groups by how
long the patient spent in critical care in total, so those who had more CC days
are at the top.

```{r critical care stay theographs, echo = FALSE, message = FALSE, results = "none"}
activity %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(pod_summary_group == "Critical Care Bed Day",
         group != "(Missing)") %>%
  group_nest(group) %>%
  pmap(function(group, data) {
    data %>%
      mutate_at("su_pat_id", as.character) %>%
      group_by(su_pat_id) %>%
      mutate(order = any(died_in_critical_care)*10000 + n()) %>%
      ungroup() %>%
      mutate_at("su_pat_id", fct_reorder, quo(order)) %>%
      ggplot(aes(proximity_to_death_days, su_pat_id)) +
      geom_tile(aes(fill = cc_pod_summary_group)) +
      scale_x_proximity_to_death_days(expand = expansion(c(0.02, 0.001))) +
      expand_limits(xlim = c(-0, 730)) +
      scale_fill_manual(values = c("Elective Admission" = su_theme_cols()[["charcoal"]],
                                   "Emergency Admission" = su_theme_cols()[["orange"]])) +
      theme(axis.text.y = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            legend.position = "none") +
      labs(title = group, x = "", y = "", fill = "")
  }) %>%
  walk(plot)
```

* Cancer and Frailty look very similar, a lot of elective, but short admissions
throughout the 24 months.
* Organ Failure has more emergency admissions scattered throughout where the
patient stays longer. Many more patients die in critical care.
* Sudden Death sees the largest percentage of deaths in critical care, and very
little activity other than in the 6 months before death.
* Other Terminal Illness is similar to Organ Failure, but with shorter stays

# Chemotherapy

Number of patients who have chemo in last month of life

```{r chemo last month}
activity %>%
  filter(chemotherapy_indicator == 1) %>%
  group_by(su_pat_id) %>%
  mutate(last_month = any(proximity_to_death_days <= 28)) %>%
  mutate_at("last_month",
            ~ifelse(.x == 1,
                    "Had chemo in last 4 weeks of life",
                    "Had chemo, but not in last 4 weeks of life")) %>%
  group_by(last_month) %>%
  summarise(nd = n_distinct(su_pat_id), .groups = "drop_last") %>%
  mutate(p = nd/sum(nd)) %>%
  ggplot(aes(last_month, p)) +
  geom_col(colour = su_theme_cols()[["orange"]],
           fill = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
  geom_label(aes(y = 0, label = comma(nd)),
             vjust = -0.5) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) +
  labs(title = "Who had chemotherapy in their last 4 weeks of life",
       x = "",
       y = "")
```

```{r chemo activity}
tibble(proximity_to_death_days = activity %>%
         pull(proximity_to_death_days) %>%
         range() %>%
         (lift_dv(seq))) %>%
  left_join(activity %>%
              filter(chemotherapy_indicator == 1) %>%
              mutate(nd = n_distinct(su_pat_id)) %>%
              count(proximity_to_death_days, nd) %>%
              mutate_at("nd", ~n / nd),
            by = c("proximity_to_death_days")) %>%
  modify_at(vars(nd, n), replace_na, 0) %>%
  ggplot(aes(proximity_to_death_days, nd)) +
  geom_jitter(alpha = 0.15,
              colour = su_theme_cols("orange")) +
  geom_smooth(fill = NA,
              colour = su_theme_cols("orange"),
              method = "loess",
              span = 0.3,
              formula = y ~ x) +
  scale_x_proximity_to_death_days() +
  scale_y_continuous(labels = comma_format(scale = 1000),
                     position = "right") +
  expand_limits(y = 0) +
  theme(legend.position = "bottom",
        axis.title.y.right = element_text(margin = margin(l = 10))) +
  labs(x = "Proximity to death (Months)",
       y = "Daily chemo activity\nper 1,000 decedents who had chemo",
       colour = "Had chemo in last 4 weeks of life?")
```

```{r chemo activity split last month}
activity %>%
  filter(chemotherapy_indicator == 1) %>%
  group_by(su_pat_id) %>%
  mutate(last_month = any(proximity_to_death_days <= 28)) %>%
  group_by(last_month) %>%
  mutate(nd = n_distinct(su_pat_id)) %>%
  count(proximity_to_death_days, nd) %>%
  ungroup() %>%
  mutate_at("nd", ~n / nd) %>%
  complete(last_month, proximity_to_death_days, fill = list(nd = 0, n = 0)) %>%
  filter(last_month | proximity_to_death_days > 28)  %>%
  rename("Number" = n,
         "Daily chemo activity\nper 1,000 decedents who had chemo" = nd) %>%
  pivot_longer(cols = -c("proximity_to_death_days", "last_month")) %>%
  group_nest(name) %>%
  pmap(function(name, data) {
    s <- ifelse(name != "Number", 1000, 1)
    
    data %>%
      mutate_at("last_month",
                ifelse,
                "later - received in last 4 weeks",
                "earlier - did not receive in last 4 weeks") %>%
      ggplot(aes(proximity_to_death_days, value, colour = last_month)) +
      geom_smooth(fill = NA,
                  method = "loess",
                  formula = y ~ x) +
      geom_vline(xintercept = 28, linetype = "dashed") +
      scale_x_proximity_to_death_days() +
      scale_y_continuous(labels = comma_format(scale = s),
                         position = "right") +
      theme(legend.position = "bottom",
            axis.title.y.right = element_text(margin = margin(0, 0, 0, 10)),
            panel.grid.major = element_line(linetype = "dotted",
                                            colour = "lightgrey")) +
      labs(x = "Proximity to death (Months)",
           y = name,
           colour = "")
  }) %>%
  walk(plot)
```

```{r chemo when do people have first chemo}
tibble(proximity_to_death_days = activity %>%
         pull(proximity_to_death_days) %>%
         range() %>%
         (lift_dv(seq))) %>%
  left_join(activity %>%
              filter(chemotherapy_indicator == 1) %>%
              group_by(su_pat_id) %>%
              summarise_at("proximity_to_death_days", max) %>%
              ungroup() %>%
              count(proximity_to_death_days),
            by = "proximity_to_death_days") %>%
  mutate_at("n", replace_na, 0) %>%
  arrange(desc(proximity_to_death_days)) %>%
  mutate_at("n", cumsum) %>%
  mutate(p = n / max(n)) %>%
  ggplot(aes(proximity_to_death_days, p)) +
  geom_step(colour = su_theme_cols()[["orange"]]) +
  scale_y_continuous(labels = percent) +
  scale_x_proximity_to_death_days() +
  labs(x = "Proximity to death (Months)",
       y = "Cumulative % of when people had\ntheir first chemo")
```

```{r chemo when do people have first chemo split last month}
activity %>%
  filter(chemotherapy_indicator == 1) %>%
  group_by(su_pat_id) %>%
  summarise(last_month = any(proximity_to_death_days <= 28),
            proximity_to_death_days = max(proximity_to_death_days),
            .groups = "drop_last") %>%
  count(proximity_to_death_days, last_month) %>%
  complete(proximity_to_death_days, last_month, fill = list(n = 0)) %>%
  filter(last_month | proximity_to_death_days > 28) %>%
  mutate_at("last_month",
            ifelse,
            "later - received in last 4 weeks",
            "earlier - did not receive in last 4 weeks") %>%
  group_by(last_month) %>%
  arrange(desc(proximity_to_death_days)) %>%
  mutate_at("n", cumsum) %>%
  mutate(p = n / max(n)) %>%
  # there is a slight dip in the first couple of days of data - this "cleans"
  # the chart up a little
  filter(proximity_to_death_days < 365*1.95) %>%
  ggplot(aes(proximity_to_death_days, p, colour = last_month)) +
  geom_step(lwd = 1) +
  geom_vline(xintercept = 28, linetype = "dashed") +
  scale_y_continuous(labels = percent,
                     position = "right") +
  scale_x_proximity_to_death_days() +
  labs(x = "Proximity to death (Months)",
       y = "Cumulative % of when people had\ntheir first chemo",
       colour = "") +
  theme(legend.position = "bottom",
        panel.grid.major = element_line(linetype = "dashed",
                                        colour = "lightgrey"),
        axis.title.y.right = element_text(margin = margin(l = 10)))
```

```{r chemo utilisation}
mpi %>%
  left_join(activity %>%
              group_by(su_pat_id) %>%
              summarise_at("chemotherapy_indicator",  any),
            by = "su_pat_id") %>%
  modify_at("chemotherapy_indicator", replace_na, FALSE) %>%
  group_by(age_band) %>%
  summarise_at("chemotherapy_indicator", mean) %>%
  ggplot(aes(age_band, chemotherapy_indicator, colour = age_band)) +
  geom_col(aes(fill = after_scale(alpha(colour, 0.4)))) +
  scale_y_continuous(labels = percent,
                     expand = expansion(c(0, 0.05))) +
  labs(x = "",
       y = "Percentage of decedents who had chemo") +
  theme(legend.position = "none")

bind_rows(
  mpi %>%
    left_join(activity %>%
                group_by(su_pat_id) %>%
                summarise_at("chemotherapy_indicator",  any),
              by = "su_pat_id") %>%
    mutate(type = "stp"),
  
  mpi_region %>%
    left_join(activity_region %>%
                group_by(su_pat_id) %>%
                summarise_at("chemotherapy_indicator",  any),
              by = "su_pat_id") %>%
    mutate(type = "region")
) %>%
  modify_at("chemotherapy_indicator", replace_na, FALSE) %>%
  group_by(type, age) %>%
  summarise_at("chemotherapy_indicator", mean) %>%
  pivot_wider(names_from = type, values_from = chemotherapy_indicator) %>%
  modify_at("stp", replace_na, 0) %>%
  ggplot(aes(age, stp)) +
  geom_point(colour = su_theme_cols("orange"),
             fill = after_scale(alpha(su_theme_cols("orange"), 0.4)),
             shape = "circle filled") +
  geom_smooth(method = "loess",
              formula = y ~ x,
              fill = NA,
              colour = su_theme_cols("orange")) +
  geom_smooth(aes(y = region),
              linetype = "dotted",
              method = "loess",
              formula = y ~ x,
              fill = NA,
              colour = su_theme_cols("charcoal")) +
  scale_y_continuous(labels = percent) +
  labs(x = "Age",
       y = "Percentage of decedents who had chemo") +
  theme(legend.position = "none")
```

```{r chemo utilisation split by years}
activity %>%
  inner_join(mpi, by = "su_pat_id") %>%
  mutate_at("age", ~case_when(.x < 50 ~ 50,
                              .x < 90 ~ .x,
                              TRUE ~ 90)) %>%
  filter(chemotherapy_indicator == 1) %>%
  mutate(year = ifelse(proximity_to_death_days <= 365,
                       "Year of death",
                       "Year prior to death")) %>%
  count(age, year, name = "activity") %>%
  inner_join(mpi %>%
               semi_join(activity %>%
                           filter(chemotherapy_indicator == 1),
                         by = "su_pat_id") %>%
               mutate_at("age", ~case_when(.x < 50 ~ 50,
                                           .x < 90 ~ .x,
                                           TRUE ~ 90)) %>%
               count(age, name = "nd"),
             by = "age") %>%
  mutate(utilisation = activity / nd) %>%
  ggplot(aes(age, utilisation, colour = year)) +
  geom_point() +
  geom_smooth(fill = NA, method = "loess", formula = y ~ x) +
  labs(x = "Age",
       y = "Chemo Usage per decedent who had chemo",
       colour = "") +
  theme(legend.position = c(0, 0),
        legend.justification = c(0, 0),
        legend.background = element_blank())
```

```{r chemo utilisation split by years by decedent}

activity %>%
  inner_join(mpi, by = "su_pat_id") %>%
  mutate_at("age", ~case_when(.x < 50 ~ 50,
                              .x < 90 ~ .x,
                              TRUE ~ 90)) %>%
  filter(chemotherapy_indicator == 1) %>%
  mutate(year = ifelse(proximity_to_death_days <= 365,
                       "Year of death",
                       "Year prior to death")) %>%
  count(age, year, name = "activity") %>%
  inner_join(mpi %>%
               semi_join(activity %>%
                           filter(chemotherapy_indicator == 1),
                         by = "su_pat_id") %>%
               mutate_at("age", ~case_when(.x < 50 ~ 50,
                                           .x < 90 ~ .x,
                                           TRUE ~ 90)) %>%
               count(age, name = "nd"),
             by = "age") %>%
  mutate(utilisation = activity / nd) %>%
  ggplot(aes(age, utilisation, colour = year)) +
  geom_point() +
  geom_smooth(fill = NA, method = "loess", formula = y ~ x) +
  labs(x = "Age",
       y = "Chemo Usage per decedent",
       colour = "") +
  theme(legend.position = c(0, 0),
        legend.justification = c(0, 0),
        legend.background = element_blank())
```

```{r chemo in last month of life binomial ci plot by cwt site}
cwt_groups <- file.path("data","reference","cwt_groups.csv") %>%
  read_csv(col_types = "cc")

activity %>%
  filter(chemotherapy_indicator == 1) %>%
  inner_join(select(mpi, su_pat_id, primary_cod), by = "su_pat_id") %>%
  mutate_at("primary_cod", ~ifelse(.x == "C770", .x, str_sub(.x, 1, 3))) %>%
  inner_join(cwt_groups, by = c("primary_cod" = "icd10")) %>%
  mutate(last_month = ifelse(proximity_to_death_days <= 28, su_pat_id, NA)) %>%
  group_by(cancer_site) %>%
  summarise(d = n_distinct(su_pat_id),
            n = n_distinct(last_month, na.rm = TRUE),
            .groups = "drop_last") %>%
  mutate(ci = map2(n, d, compose(as_tibble, BinomCI))) %>%
  unnest(ci) %>%
  mutate(mean_est = sum(n) / sum(d),
         colour = case_when(
           upr.ci < mean_est ~ "orange",
           lwr.ci > mean_est ~ "red",
           TRUE ~ "charcoal"
         )) %>%
  mutate_at("cancer_site", fct_reorder, quo(-est)) %>%
  ggplot(aes(fct_rev(cancer_site), est, colour = colour)) +
  geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci)) +
  geom_point(aes(fill = after_scale(alpha(colour, 0.4)))) +
  geom_hline(aes(yintercept = mean_est),
             linetype = "dashed") +
  coord_flip() +
  scale_colour_manual(values = su_theme_cols()) +
  scale_y_continuous(labels = percent) +
  labs(x = "", y = "% of patients who have chemo in last month before death") +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgrey",
                                          linetype = "dotted"),
        legend.position = "none")
```

```{r chemo in last month of life binomial ci plot by age band}

activity %>%
  filter(chemotherapy_indicator == 1) %>%
  inner_join(select(mpi, su_pat_id, age_band), by = "su_pat_id") %>%
  mutate(last_month = ifelse(proximity_to_death_days <= 28, su_pat_id, NA)) %>%
  group_by(age_band) %>%
  summarise(d = n_distinct(su_pat_id),
            n = n_distinct(last_month, na.rm = TRUE),
            .groups = "drop_last") %>%
  mutate(ci = map2(n, d, compose(as_tibble, BinomCI))) %>%
  unnest(ci) %>%
  mutate(mean_est = sum(n) / sum(d),
         colour = case_when(
           upr.ci < mean_est ~ "orange",
           lwr.ci > mean_est ~ "red",
           TRUE ~ "charcoal"
         )) %>%
  ggplot(aes(fct_rev(age_band), est, colour = colour)) +
  geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci)) +
  geom_point(aes(fill = after_scale(alpha(colour, 0.4)))) +
  geom_hline(aes(yintercept = mean_est),
             linetype = "dashed") +
  coord_flip() +
  scale_colour_manual(values = su_theme_cols()) +
  scale_y_continuous(labels = percent) +
  labs(x = "", y = "% of patients who have chemo in last month before death") +
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_line(colour = "lightgrey",
                                          linetype = "dotted"),
        legend.position = "none")
```

# Extra mekko charts

```{r cc mekko - died in CC}
mpi %>%
  filter(group != "(Missing)") %>%
  mutate_at(vars(group),
            compose(fct_rev, fct_recode),
            "Sudden\nDeath" = "Sudden Death",
            "OTI" = "Other Terminal Illness") %>%
  drop_na(died_in_critical_care) %>%
  mutate_at("died_in_critical_care", ~ifelse(.x == 1, "Yes", "No")) %>%
  mekko_chart(group, died_in_critical_care)

```

```{r cc mekko - admission method split}
activity %>%
  inner_join(select(mpi, su_pat_id, group),
             by = "su_pat_id") %>%
  filter(group != "(Missing)",
         pod_summary_group == "Critical Care Bed Day") %>%
  mutate_at(vars(group),
            compose(fct_rev, fct_recode),
            "Sudden\nDeath" = "Sudden Death",
            "OTI" = "Other Terminal Illness") %>%
  mutate_at("cc_pod_summary_group", str_replace, " ", "\n") %>%
  mekko_chart(group, cc_pod_summary_group)
```

# Ambulance Arrivals

```{r AandE arrival volumes}
activity_ambulance %>%
  count(proximity_to_death_days, arrival_mode, wt = n) %>%
  complete(proximity_to_death_days = seq(1, 729),
           arrival_mode,
           fill = list(n = 0)) %>%
  ggplot(aes(proximity_to_death_days, n, colour = arrival_mode)) +
  geom_smooth(method = "loess",
              formula = y ~ x,
              span = 0.2,
              fill = NA) +
  scale_x_proximity_to_death_days() +
  expand_limits(y = 0) +
  labs(x = "Proximity to death (months)",
       y = "Number of A&E arrivals",
       colour = "") +
  theme(legend.position = c(0.02, 1),
        legend.justification = c(0, 1),
        legend.key = element_blank(),
        legend.title = element_blank())
```

```{r Ambulance pcnt by cod group}
activity_ambulance %>%
  count(arrival_mode, proximity_to_death_days, group, wt = n) %>%
  complete(proximity_to_death_days =
             seq(min(activity_ambulance$proximity_to_death_days),
                 max(activity_ambulance$proximity_to_death_days)),
           arrival_mode,
           group,
           fill = list(n = 0)) %>%
  pivot_wider(names_from = arrival_mode, values_from = n) %>%
  mutate(total = ambulance + other,
         ci = map2(ambulance, total, compose(as_tibble, BinomCI))) %>%
  filter(group != "(Missing)") %>%
  group_by(group) %>%
  mutate(line_label = ifelse(proximity_to_death_days == max(proximity_to_death_days),
                             as.character(group),
                             NA)) %>%
  ungroup() %>%
  unnest(cols = c(ci)) %>%
  ggplot(aes(proximity_to_death_days, est, colour = group)) +
  geom_smooth(method = "loess",
              formula = y ~ x,
              span = 0.2,
              fill = NA) +
  scale_x_proximity_to_death_days() +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     position = "right") +
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = "Proximity to death (months)",
       y = "% of A&E arrivals by Ambulance",
       colour = "") +
  theme(legend.position = c(0, 0),
        legend.justification = c(0, 0),
        legend.direction = "horizontal",
        legend.key = element_blank(),
        axis.title.y.right = element_text(margin = margin(l = 10)))
```

# Terminal Episode LoS

```{r terminal episode los}
# this is likely to be different to Justine's outputs as I correct for the dod
tlos <- activity %>%
  semi_join(mpi, by = c("su_pat_id", "discharge_date" = "dod")) %>%
  filter(pod_summary_group %in% c("Emergency Admission",
                                  "Elective Admission")) %>%
  group_by(pod_summary_group) %>%
  count(proximity_to_death_days)
```

```{r tlos count plot}
tlos %>%
  filter(proximity_to_death_days <= 42) %>%
  ggplot(aes(proximity_to_death_days, n)) +
  geom_col(colour = su_theme_cols("orange"),
           fill = after_scale(alpha(su_theme_cols("orange"), 0.4)),
           width = 1) +
  scale_x_continuous(trans = "reverse",
                     breaks = seq(0, 70, by = 7)) +
  scale_y_continuous(expand = expansion(c(0, 0.05)),
                     position = "right") +
  facet_wrap(vars(pod_summary_group), ncol = 1, scales = "free") +
  labs(x = "Bed days for Terminal Spell",
       y = "Number of Terminal Spells")
```

```{r tlos pcnt bed days plot}
tlos %>%
  filter(proximity_to_death_days <= 42) %>%
  mutate(n = (proximity_to_death_days+1) * n,
         p = n) %>% # / sum(n)) %>%
  ggplot(aes(proximity_to_death_days, p)) +
  geom_col(colour = su_theme_cols("orange"),
           fill = after_scale(alpha(su_theme_cols("orange"), 0.4)),
           width = 1) +
  scale_x_continuous(trans = "reverse",
                     breaks = seq(0, 70, by = 7)) +
  scale_y_continuous(expand = expansion(c(0, 0.05)),
                     # labels = percent,
                     position = "right") +
  facet_wrap(vars(pod_summary_group), ncol = 1, scales = "free") +
  labs(x = "Bed days for Terminal Spell",
       y = "Total Number of Bed days for Terminal Spell")
```

```{r tlos pcnt bed days plot cumulative}
tlos %>%
  arrange(-proximity_to_death_days) %>%
  mutate(n = (proximity_to_death_days+1) * n,
         p = cumsum(n)/sum(n)) %>%
  filter(proximity_to_death_days <= 140) %>%
  ggplot(aes(proximity_to_death_days, p, colour = pod_summary_group)) +
  geom_step() +
  scale_x_continuous(trans = "reverse",
                     breaks = seq(0, 140, by = 7)) +
  scale_y_continuous(expand = expansion(c(0, 0.05)),
                     labels = percent,
                     position = "right") +
  #facet_wrap(vars(pod_summary_group), ncol = 1, scales = "free") +
  labs(x = "Bed days for Terminal Spell",
       y = "Cumulative Bed days for Terminal Spell") +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```
