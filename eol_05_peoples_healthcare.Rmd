---
title: "End of Life"
author: "[The Strategy Unit][su_web]"
date: "25/11/2019"
output:
  StrategyUnitTheme::su_document: default
params:
  stp: "E54000016"
---


```{r setup, include = FALSE}
library(knitr)
# knitr options ----
opts_chunk$set(echo = FALSE, eval.after = "fig.cap")

if (!knitr::is_latex_output()) {
  opts_chunk$set(dpi = 300,
                 dev.args = list(type = "cairo"))
}

# all setup should happen in setup.R that could be shared logic between files
invisible(local({
  source("setup.R")
  load_data(params$stp)
}))

library(flextable)
library(officer)
library(magrittr)
```

# Peoples’ healthcare
## How we care for people in the two years before death

In this chapter we consider who access healthcare, which services they utilise,
how utilisation of services changes over time and the level of resource
consumed. We also calculate future demand based on current utilisation rates and
extrapolate these forward using the future forecast deaths.

We do this for the services which have patient level data available. This
includes….

### Healthcare activities, classification and service sub-groups

From the datasets used in this report services have been grouped into four
different healthcare activity types, comprised of the following service groups:

```{r}
activity %>%
  distinct(pod_type, pod_summary_group) %>%
  arrange(pod_type, pod_summary_group) %>%
  mutate(o = rep(1:3, 4)) %>%
  pivot_wider(names_from = pod_type, values_from = pod_summary_group) %>%
  mutate_at("o", ~"Service Group") %>%
  flextable() %>%
  add_header_row(values = c("",rep("Activity Type", 4))) %>%
  merge_h(part = "header") %>%
  merge_v(j = 1) %>%
  width(1, .7) %>%
  width(2:5, 1.5) %>%
  border_remove() %>%
  border(1:3, 1:5,
         border.left = fp_border(),
         border.right = fp_border()) %>%
  border(1, border.top = fp_border()) %>%
  border(3, border.bottom = fp_border()) %>%
  border(1, 1, border.bottom = fp_border()) %>%
  border(1, 2:5,
         border.top = fp_border(),
         border.left = fp_border(),
         border.right = fp_border(),
         part = "header") %>%
  border(2, 2:5,
         border.left = fp_border(),
         border.right = fp_border(),
         part = "header") %>%
  set_header_labels("o" = "") %>%
  align(align = "center", part = "all") %>%
  bg(1, 1, bg = "#EEEEEE") %>%
  bg(1:2, 2:5, bg = "#EEEEEE", part = "header") %>%
  font(fontname = "Segoe UI Semilight", part = "all") %>%
  fontsize(size = 9, part = "all")
```

###	Who accesses which activity type?

```{r activity summary text, include=FALSE}
stp_deaths <- nrow(mpi)
stp_activity <- activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    as.character(pod_summary_group),
                    as.character(.x))) %>%
  distinct(pod_type, su_pat_id) %>%
  count(pod_type) %$%
  set_names(percent(n / stp_deaths, accuracy = 1),
            pod_type)
stp_activity
```

Of the `r comma(stp_deaths)` people who died in in your STP nearly all of them
(`r stp_activity[["Urgent Service Event"]]`) had at least one type of urgent
service event in the period before death. This is also true also for planned
contacts (`r stp_activity[["Planned Contact"]]`). The level of access is much
lower for planned admissions (`r stp_activity[["Planned Admission"]]`) and
critical care beds (`r stp_activity[["Critical Care Bed Day"]]`).

Although access gives a sense of who is in contact with healthcare services it
does not consider the volume or pattern of activity. These are considered in
later sections of this chapter.

#### percentage of all decedents who access healthcare activity types

```{r activity pcnt, fig.height = 2.3}
bind_rows(
  mutate(activity, type = "stp"),
  mutate(activity_region, type = "region")
) %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  group_by(type, pod_type, su_pat_id) %>%
  summarise(n = sign(n())) %>%
  summarise_at("n", sum) %>%
  inner_join(
    bind_rows(
      mpi %>%
        summarise(patients = n_distinct(su_pat_id)) %>%
        mutate(type = "stp"),
      
      mpi_region %>%
        summarise(patients = n_distinct(su_pat_id)) %>%
        mutate(type = "region"),
    ),
    by = c("type")
  ) %>%
  mutate_at("n", ~.x / patients) %>%
  select(-patients) %>%
  pivot_wider(names_from = "type", values_from = "n") %>%
  #filter(!pod_type %in% c("Bed")) %>% 
  ungroup() %>%
  ggplot(aes(pod_type, stp)) +
  geom_col(aes(colour = pod_type,
               fill = after_scale(alpha(colour, 0.4)))) +
  geom_point(aes(y = region,
                 colour = pod_type,
                 fill = after_scale(alpha(colour, 0.4))),
             show.legend = FALSE,
             size = 2,
             shape = "circle filled",
             stroke = 1.5) +
  scale_y_continuous(labels = percent,
                     expand = expansion(c(0, 0.05))) +
  expand_limits(y = c(0, 1)) +
  labs(x = "", y = "", colour = "", fill = "")  +
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank())
```

### Who accesses which service group?

With each activity type the level of access does differ by service. For example,
we see in prior chart n that the majority of the people who died in your STP
access planned contacts. By service the driver is outpatient contacts and a very
small number have access mental health or IAPT.

#### percentage of all decedents who access services (at least one event/contact/admission/bed day) in the two year period before their death

```{r activity pcnt pod summary group}
bind_rows(
  mutate(activity, type = "stp"),
  mutate(activity_region, type = "region")
) %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  group_by(type, pod_type, pod_summary_group, su_pat_id) %>%
  summarise(n = sign(n())) %>%
  summarise_at("n", sum) %>%
  inner_join(
    bind_rows(
      mpi %>%
        summarise(patients = n_distinct(su_pat_id)) %>%
        mutate(type = "stp"),
      
      mpi_region %>%
        summarise(patients = n_distinct(su_pat_id)) %>%
        mutate(type = "region"),
    ),
    by = c("type")
  ) %>%
  mutate_at("n", ~.x / patients) %>%
  select(-patients) %>%
  pivot_wider(names_from = "type", values_from = "n") %>%
  #filter(!pod_type %in% c("Bed")) %>% 
  ungroup() %>%
  ggplot(aes(pod_summary_group, stp)) +
  geom_col(aes(colour = pod_type,
               fill = after_scale(alpha(colour, 0.4)))) +
  geom_point(aes(y = region,
                 colour = pod_type,
                 fill = after_scale(alpha(colour, 0.4))),
             show.legend = FALSE,
             size = 2,
             shape = "circle filled",
             stroke = 1.5) +
  #scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  scale_x_discrete(labels = partial(str_wrap, width = 10)) +
  scale_y_continuous(labels = percent,
                     expand = expansion(c(0, 0.05))) +
  expand_limits(y = c(0, 1)) +
  labs(x = "", y = "", colour = "", fill = "")  +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 30, hjust = 1),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank())
```

### How utilisation changes over time

From who accesses care we now look at the volume and pattern of utilisation over
time. We know from experience that **utilisation will change over time** with a
resultant 'pattern' or 'utilisation curve'. Here the concept of time is the time
before death so, regardless of any actual calendar date, it is the time between
when **a healthcare activity takes place for a person and their date of death.**
Activity taking place on the day of death is a time of 0 days, taking place the
day before death is 1 day and so on. 

Here we consider utilisation curves for different healthcare activities over
time, how they increase, decrease and at what point in the end of life journey a
peak is reached. 

### Utilisation curves

In the following series of utilisation curves we show utilisation over time for
your STP and how this compares to the Midlands (on a non-standardised per person
basis).

We show the utilisation data points for your STP (yellow dots); utilisation curve
for your STP (yellow line); utilisation curve for the Midlands as a whole
(dashed grey line). Utilisation curves are calculated using locally estimated
scatterplot smoothing (LOESS)[^1].

```{r utilisation curve plots, include=FALSE}
util_curve_plots <- local({
  df <- bind_rows(
    mutate(activity, type = "stp"),
    mutate(activity_region, type = "region")
  ) %>%
    mutate_at("pod_type",
              ~ifelse(pod_summary_group == "Critical Care Bed Day",
                      "Critical Care Bed Day",
                      as.character(.x))) %>%
    mutate_at("pod_type",
              fct_relevel,
              c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
    count(type, pod_type, proximity_to_death_days) %>%
    inner_join(tribble(~type, ~p,
                       "stp", nrow(mpi),
                       "region", nrow(mpi_region)),
               by = "type") %>%
    mutate_at("n", ~n / p) %>%
    select(-p) %>%
    pivot_wider(names_from = type, values_from = n) %>%
    modify_at(vars(region, stp), replace_na, 0) %>%
    group_by(pod_type) %>%
    mutate(tml = pmax(region, stp) %>% ifelse(. == max(.), ., NA)) %>%
    ungroup() %>%
    group_nest(pod_type)
  
  plots <- pmap(df, function(pod_type, data) {
    data %>%
      ggplot(aes(proximity_to_death_days, stp)) +
      geom_smooth(span = 0.15,
                  formula = y ~ x,
                  method = "loess",
                  fill = NA,
                  colour = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
      geom_smooth(aes(y = region),
                  linetype = "dotted",
                  span = 0.15,
                  formula = y ~ x,
                  method = "loess",
                  fill = NA,
                  colour = after_scale(alpha(su_theme_cols()[["charcoal"]], 0.4))) +
      geom_point(size = 0.2,
                 shape = "circle filled",
                 colour = su_theme_cols()[["orange"]],
                 fill = after_scale(alpha(su_theme_cols()[["orange"]], 0.4))) +
      geom_text(aes(x = 3*365/12+10, y = tml),
                label = "3 months prior to death",
                hjust = 1,
                size = 3,
                na.rm = TRUE) +
      geom_vline(xintercept = 3*365/12,
                 linetype = "dashed",
                 colour = su_theme_cols()[["dark_charcoal"]]) +
      scale_x_proximity_to_death_days() +
      scale_y_continuous(sec.axis = dup_axis(labels = comma_format(scale = 1000),
                                             name = "Activity per 1,000 Decedants")) +
      theme(panel.grid.major = element_line(colour = "grey",
                                            size = 0.25,
                                            linetype = "dotted"),
            axis.title = element_text(size = 8),
            axis.title.y.left = element_blank(),
            axis.text.y.left = element_blank(),
            axis.ticks.y.left = element_blank(),
            legend.position = "bottom") +
      labs(x = "Proximity to Death (Months)", y = "", colour = "")
    })
  
  set_names(plots, as.character(df$pod_type))
})
```

**Urgent service events** start low and increase slowly for much of the period.
Then, in the few months prior to death, there is a rapid rate of increase rising
to a sharp peak in the last few days.

```{r util_curve_plots Urgent Service Event, fig.height = 2.5}
util_curve_plots$`Urgent Service Event`
```

**Planned contacts** rise steadily throughout the period until a sharp peak in
the weeks prior to death at which point they decline steeply.

```{r util_curve_plots Planned Contact, fig.height = 2.5}
util_curve_plots$`Planned Contact`
```

**Planned admissions** also rise steadily throughout the period with a rounded
peak a matter of months prior to death.

```{r util_curve_plots Planned Admission, fig.height = 2.5}
util_curve_plots$`Planned Admission`
```

**Bed days**, created when an admission to a bed takes place, closely follows
the utilisation curve of urgent service events as bed occupancy is dominated by
people who occupy a bed after being admitted as an emergency.

```{r util_curve_plots Bed Days, fig.height = 2.5}
util_curve_plots$Bed
```

**Critical care bed days** start low and do not increase until a sharp rise in
the weeks prior to death.

```{r util_curve_plots Critical Care Bed Day, fig.height = 2.5}
util_curve_plots$`Critical Care Bed Day`
```

### Utilisation curves by cause of death group

Utilisation curves disaggregated by cause of death group show that although we
have seen in chapter n that cancer deaths only equate to a fifth of the overall
population, they take up proportionally more activity in both planned activity
types (planned contact and planned admission). This reflects the nature of their
treatment which requires a series of regular planned admissions and contacts.

For urgent service events, and bed days, there is little differentiation between
causes of death group in either pattern or volume. 

```{r utilisation curve grouped, message=FALSE,  echo=FALSE, results = "none", fig.height=3.1}
activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  inner_join(select(mpi, su_pat_id, group), by = "su_pat_id") %>%
  filter(group != "(Missing)") %>%
  count(pod_type, group, proximity_to_death_days) %>%

  inner_join(count(mpi, group, name = "p"), by = "group") %>%
  mutate_at("n", ~n/p) %>%
  
  group_nest(pod_type) %>%
  pmap(function(pod_type, data) {
    data %>%
      ggplot(aes(proximity_to_death_days, n, colour = group)) +
      geom_smooth(span = 0.15,
                  formula = y ~ x,
                  method = "loess",
                  fill = NA) +
      # geom_point(size = 0.2, alpha = 0.2) +
      geom_vline(xintercept = 3*365/12,
                 linetype = "dashed",
                 colour = su_theme_cols()[["dark_charcoal"]]) +
      scale_x_proximity_to_death_days() +
      scale_y_continuous(sec.axis = dup_axis(labels = comma_format(scale = 1000),
                                             name = "Activity per 1,000 Decedants")) +
      theme(panel.grid.major = element_line(colour = "grey",
                                            size = 0.25,
                                            linetype = "dotted"),
            axis.text.y.left = element_blank(),
            axis.ticks.y.left = element_blank(),
            legend.position = "bottom") +
      labs(title = pod_type, x = "Proximity to Death (Months)", y = "", colour = "") +
      annotate("text",
               x = 3*365/12+10,
               y = max(data$n),
               label = "3 months prior to death",
               hjust = 1,
               size = 3)
  }) %>%
  walk(plot)
```

### Summarising utilisation

The utilisation curves provide a detailed day by day view of activity but a 
straightforward measure summarising utilisation would also allow us to make 
comparisons across a range of factors.

To this end in this section we calculate a ‘utilisation ratio’ which represents 
the average activity a person would experience in a year period. 

In our analysis we have chosen to calculate these ratios separately between the 
first year period before death and the second year period before death. This 
acknowledges how these ratios change over time whilst remaining simple enough to 
make meaningful comparisons.

$$
\textrm{Utilisation ratio in first year prior to death}\ (UR_1) =
  \frac{\Sigma\textrm{Activity in first year prior to death}}
  {\textrm{Decededent population}}
$$
$$
\textrm{Utilisation ratio in second year prior to death}\ (UR_2) =
  \frac{\Sigma\textrm{Activity in second year prior to death}}
  {\textrm{Decededent population}}
$$

### Utilisation ratios by age

Utilisation ratios are for each service group within an activity type. They are 
presented by age, where age is the age at death.

All people aged under 50 are grouped in one age group, as are all people aged 
over 90. This is because they are very small populations by single year of age,
leading to high variability.

```{r utilisation rates}
util_rates_plots <- local({
  activity_counts <- activity %>%
    # mutate_at("pod_summary_group",
    #           ~ifelse(pod_type == "Critical Care Bed Day", "CC", as.character(.x))) %>%
    # mutate_at("pod_type", fct_recode, "Bed" = "Critical Care Bed Day") %>%
    inner_join(select(mpi, su_pat_id, age),
               by = "su_pat_id") %>%
    mutate(activity_year = as.numeric(proximity_to_death_days >= 365)) %>%
    mutate_at("age", ~case_when(.x > 90 ~ 90,
                                .x < 50 ~ 50,
                                TRUE ~ .x)) %>%
    mutate_if(is.factor, as.character) %>%
    count(pod_type, pod_summary_group, activity_year, age,
          name = "activity")
  
  death_counts <- mpi %>%
      mutate_at("age", ~case_when(.x > 90 ~ 90,
                                  .x < 50 ~ 50,
                                  TRUE ~ .x)) %>%
      count(age, name = "deaths")
  
  activity_column_combinations <- list(type = activity_counts %>%
                                         distinct(pod_type, pod_summary_group) %>%
                                         pmap(paste, sep = "|"),
                                       activity_year = c(0, 1),
                                       age = 50:90) %>%
    cross_df() %>%
    separate(type, c("pod_type", "pod_summary_group"), sep = "\\|")
  
  df <- activity_column_combinations %>%
    left_join(inner_join(activity_counts, death_counts, by = c("age")) %>%
                mutate(utilisation = activity/deaths),
              by = colnames(activity_column_combinations)) %>%
    replace_na(list(utilisation = 0,
                    activity = 0,
                    deaths = 0)) %>%
    group_by(age, pod_type, pod_summary_group, activity_year) %>%
    summarise_at(vars(activity, deaths), sum) %>%
    mutate(utilisation = activity/deaths) %>%
    ungroup() %>%
    group_nest(pod_type)
  
  df %>%
    pmap(function(pod_type, data) {
      data %>%
        mutate_at("pod_summary_group",
                  ~fct_reorder(.x, activity, .fun = sum)) %>%
        mutate_at("activity_year",
                  ifelse,
                  "Year before death",
                  "Year of death") %>%
        ggplot(aes(age, utilisation, colour = activity_year)) +
        geom_point(na.rm = TRUE) +
        geom_smooth(fill = NA, method = "loess", formula = y ~ x, na.rm = TRUE) +
        expand_limits(y = 0) +
        facet_wrap(vars(pod_summary_group), scales = "free") +
        theme(legend.position = "bottom",
              axis.title = element_blank()) +
        labs(x = "", y = "", colour = "")
    }) %>%
    set_names(df$pod_type)
})
```

**Urgent service events** show that:

1. for each single year of age at death utilisation does not differ greatly.
So, in the year before their death a person who dies aged 80 years old is
expected to have a similar amount of emergency admissions as to a person who is
50 when they die. The same is also true for A&E attendances. Calls to 111 do 
however tend to increase for patients in their 70s.

2. there are similar volumes between the unplanned care services of emergency
admissions and A&E attendances (around 2 per person in first year period before
death and around 0.75 per person in second year period before death). These are
both only slightly higher than calls to 111.
 
#### utilisation ratio of activity per person, by age at death, over first year period prior to death and second year period prior to death

```{r utilisation rates urgent service events, fig.height=2.6}
util_rates_plots[["Urgent Service Event"]]
```

**Planned contacts** show that:

1. planned contacts are dominated by outpatient attendances with between 5-15
per person per year.

2. utilisation decreases as age increases in both first year period and the
second year period before death. Indeed, as age increases the less difference in
utilisation there is between the first year period and second year period. 

#### utilisation ratio of activity per person, by age at death, over first year period prior to death and second year period prior to death

```{r utilisation rates planned contact, fig.height=2.6}
util_rates_plots[["Planned Contact"]]
```

**Planned admissions** show that:

1. although there is a general pattern of utilisation decreasing as age
increases, day case admissions in particular show increasing utilisation for
patients in their 50s.

2. regular attendances show little variation between the first year period and
the second year period before death. 

#### utilisation ratio of activity per person, by age at death, over first year period prior to death and second year period prior to death

```{r utilisation rates planned admission, fig.height=2.6}
util_rates_plots[["Planned Admission"]]
```

**Bed days** show that:

1. bed days are dominated by emergency bed days. They show that in the second
year before death utilisation does not differ greatly. However, in the first
year before death not only does utilisation increase significantly for all ages
but utilisation increases with age.

2. the utilisation value here also represents the average length of stay in a
year. So for example, a utilisation of 20 would mean that an average of 20 bed
days are occupied per person in a year period.

#### utilisation ratio of activity per person, by age at death, over first year period prior to death and second year period prior to death

```{r utilisation rates bed, fig.height=2.6}
util_rates_plots[["Bed"]]
```

### Resource usage

Beyond the activity the population utilises is the resource associated with that
activity. For example, although outpatient attendances are high volume the
resource for an outpatient attendance is very much less than the resource
required for an emergency admission including a procedure and associated bed
days.

Here we use costs derived from national and local sources as an indicative
measure of the resource consumed by the population.   

## Translating forecast deaths into future demand

How the demands on healthcare services change in future years will depend on
many factors.

They will be driven by how many people are dying, what resources and 
interventions each person utilises as they approach end of life and what
services (downstream and upstream) are available to meet an individual’s need.

In chapter n we have seen how deaths were already expected to rise over future 
decades; we have seen how these estimates were lower than actual deaths (where 
both forecast and actual data co-exist), indicating estimates may have
previously been too conservative. We have also seen the novel coronavirus 
disease COVID-19 develop across the world with its full direct and indirect 
effects on mortality as yet unknown.  

In this context the forecast future healthcare demand provides a useful starting
point. By using the current utilisation ratios from this chapter and the 
forecast future deaths from chapter n we can estimate the volume of activity 
required purely to manage what we now know would have been an extremely positive
scenario for numbers of deaths and <health resource planned?>.

Forecast activity for unplanned healthcare would continue to increase over 
coming decades driven by the increasing number of deaths in the older population
and the fact that utilisation ratios for this segment of the population are 
extremely similar to younger groups.

For both planned types of activity we do not see the same increasing level of
activity. This is an artefact that other we see more deaths in the older
population we know utilisation ratios decline with age for planned services.

```{r forecast activity 5 year bars, echo=FALSE, message=FALSE, results='hide', fig.height = 3.1}
forecast_activity %>%
  mutate_at("pod_type",
            ~ifelse(pod_summary_group == "Critical Care Bed Day",
                    "Critical Care Bed Day",
                    as.character(.x))) %>%
  mutate_at("pod_type",
            fct_relevel,
            c(levels(activity$pod_type), "Critical Care Bed Day")) %>%
  filter(year %% 5 == 0) %>%
  group_by(age_band, year, pod_type) %>%
  summarise_at(vars(est_deaths, activity), sum) %>%
  ungroup() %>%
  group_nest(pod_type) %>%
  pwalk(function(pod_type, data) {
    p <- data %>%
      ggplot(aes(year, activity)) +
      geom_col(aes(fill = fct_rev(age_band)),
               alpha = 0.4,
               colour = "white",
               position = "stack") +
      stat_summary(aes(label = scales::comma(..y..,
                                             accuracy = 1)),
                   vjust = -.3,
                   fun   = sum,
                   geom  = "text") +
      scale_y_continuous(labels = scales::comma_format(scale = .001),
                         expand = expansion(c(0, 0.15))) +
      scale_fill_discrete(guide = guide_legend(reverse = TRUE)) +
      labs(fill = "",
           y = "Activity (1,000's)",
           title = pod_type) +
      theme(legend.position = "bottom")
    plot(p)
  })
```

[//]: <> (URL's / References --------------------------------------------------)
[su_email]: mailto:Strategy.Unit@nhs.net
[su_web]: https://www.strategyunitwm.nhs.uk/

[^1]: [Local Regression on Wikipedia](https://en.wikipedia.org/wiki/Local_regression)
